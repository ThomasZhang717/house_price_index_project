---
title: "index_quality"
author: "Zhuoran"
date: "31/12/2021"
output: html_document
---

#libraries
```{r}
library(foreign)
library(dplyr)
library(lubridate)
library(ggplot2)
library(caret)
```



#test the quality of index
#forward
```{r}
abs_index = read.csv("./data/abs_index.csv")
colnames(abs_index) = c("quarter", "index")
abs_index$index = abs_index$index/abs_index$index[1]*100


resale_test = model_resale %>%
  filter(model_resale$resale_freq > 2)

resale_test$resale_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale_lad = 0
resale_test$abs_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale_alt = 0

#forward predict
for (i in 1:(nrow(resale_test)-1)) {
  if(resale_test$PARCEL_I[i+1] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+1] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+1] = resale_test$SALE1[i] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+1])]
      resale_test$gbm_hedonic_indexed_sale[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+1])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+1])]
      resale_test$abs_indexed_sale[i+1] = resale_test$SALE1[i] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+1])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+1])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-2)) {
  if(resale_test$PARCEL_I[i+2] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+2] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+2] = resale_test$SALE1[i] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+2])]
      resale_test$gbm_hedonic_indexed_sale[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+2])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+2])]
      resale_test$abs_indexed_sale[i+2] = resale_test$SALE1[i] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+2])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+2])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-3)) {
  if(resale_test$PARCEL_I[i+3] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+3] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+3] = resale_test$SALE1[i] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+3])]
      resale_test$gbm_hedonic_indexed_sale[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+3])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+3])]
      resale_test$abs_indexed_sale[i+3] = resale_test$SALE1[i] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+3])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+3])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-4)) {
  if(resale_test$PARCEL_I[i+4] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+4] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+4] = resale_test$SALE1[i] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+4])]
      resale_test$gbm_hedonic_indexed_sale[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+4])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+4])]
      resale_test$abs_indexed_sale[i+4] = resale_test$SALE1[i] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+4])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+4])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-5)) {
  if(resale_test$PARCEL_I[i+5] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+5] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+5] = resale_test$SALE1[i] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+5])]
      resale_test$gbm_hedonic_indexed_sale[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+5])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+5])]
      resale_test$abs_indexed_sale[i+5] = resale_test$SALE1[i] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+5])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+5])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-6)) {
  if(resale_test$PARCEL_I[i+6] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+6] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+6] = resale_test$SALE1[i] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+6])]
      resale_test$gbm_hedonic_indexed_sale[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+6])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+6])]
      resale_test$abs_indexed_sale[i+6] = resale_test$SALE1[i] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+6])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+6])]
    }
  }
  print(i)
}


resale_test = resale_test %>%
  filter(resale_test$train_test == "test")

resale_test = resale_test %>%
  filter(resale_test$resale_indexed_sale > 0 | resale_test$gbm_hedonic_indexed_sale_lad > 0)

RMSE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad))
RMSE(log(resale_test$SALE1), log(resale_test$abs_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$abs_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_alt))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_alt))

MAE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad)))
MAE(log(resale_test$SALE1), log(resale_test$abs_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$abs_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_alt))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_alt)))
```


#backward
```{r}
resale_test = model_resale %>%
  filter(model_resale$resale_freq > 2)

resale_test$resale_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale_lad = 0
resale_test$abs_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale_alt = 0

#backward predict
for (i in 1:(nrow(resale_test)-1)) {
  if(resale_test$PARCEL_I[i+1] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+1] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+1] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+1])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+1] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+1])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+1] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+1])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])]
      resale_test$abs_indexed_sale[i] = resale_test$SALE1[i+1] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+1])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+1] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+1])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-2)) {
  if(resale_test$PARCEL_I[i+2] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+2] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+2] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+2])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+2] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+2])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+2] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+2])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])]
      resale_test$abs_indexed_sale[i] = resale_test$SALE1[i+2] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+2])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+2] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+2])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-3)) {
  if(resale_test$PARCEL_I[i+3] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+3] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+3] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+3])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+3] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+3])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+3] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+3])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])]
      resale_test$abs_indexed_sale[i] = resale_test$SALE1[i+3] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+3])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+3] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+3])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-4)) {
  if(resale_test$PARCEL_I[i+4] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+4] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+4] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+4])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+4] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+4])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+4] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+4])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])]
      resale_test$abs_indexed_sale[i] = resale_test$SALE1[i+4] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+4])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+4] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+4])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-5)) {
  if(resale_test$PARCEL_I[i+5] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+5] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+5] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+5])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+5] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+5])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+5] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+5])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])]
      resale_test$abs_indexed_sale[i] = resale_test$SALE1[i+5] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+5])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+5] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+5])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-6)) {
  if(resale_test$PARCEL_I[i+6] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+6] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+6] / resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i+6])] * resale_index$index[which(resale_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+6] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i+6])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+6] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i+6])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$quarter == resale_test$quarter_num[i])]
      resale_test$abs_indexed_sale[i] = resale_test$SALE1[i+6] / abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i+6])] * abs_index$index[which(abs_index$quarter == resale_test$quarter_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+6] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i+6])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$quarter == resale_test$quarter_num[i])]
    }
  }
  print(i)
}

resale_test = resale_test %>%
  filter(resale_test$train_test == "test")

resale_test = resale_test %>%
  filter(resale_test$resale_indexed_sale > 0 | resale_test$gbm_hedonic_indexed_sale_lad > 0)

RMSE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad))
RMSE(log(resale_test$SALE1), log(resale_test$abs_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$abs_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_alt))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_alt))

MAE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad)))
MAE(log(resale_test$SALE1), log(resale_test$abs_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$abs_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_alt))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_alt)))
```



#index plot
```{r}
indice = rbind(gbm_hedonic_index_impute, gbm_hedonic_index_lad, resale_index, abs_index)
indice$method = c(rep("Hedonic Impute Index", 68), rep("PDP", 68), rep("Repeat Sale", 68), rep("ABS", 68))
ggplot(indice, aes(quarter, index, color = method)) + geom_line()
```