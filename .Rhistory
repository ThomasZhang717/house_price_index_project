#full$d_strata[which(full$d_strata == 0)] = "nonstrata"
full$sale_flat = NA
full$sale_flat_pre = NA
#flat by median price
for (i in 86:129) {
full$sale_flat[which(full$quarter_num == i)] = full$SALE1[which(full$quarter_num == i)]/abs$index[i]
}
for (i in 61:129) {
full$sale_flat_pre[which(full$quarter_num_pre == i)] = full$SALE2[which(full$quarter_num_pre == i)]/abs$index[i]
}
full$sale_flat_pre[which(full$YEAR_BUI>full$year_pre)] = NA
full$quarter_num_pre[which(full$YEAR_BUI>full$year_pre)] = NA
full$SALE2[which(full$YEAR_BUI>full$year_pre)] = NA
full$SALE2[which(full$SALE2 == 0)] = NA
full$DATE2[which(full$YEAR_BUI>full$year_pre)] = NA
full$sale_flat_z = NA
full$sale_flat_pre_z = NA
full$land_z = NA
full$house_size_z = NA
full$sale_flat_z_pool = NA
full$sale_flat_pre_z_pool = NA
full$land_z_pool = NA
full$house_size_z_pool = NA
full$sale_flat_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "APARTMENT")]))
full$sale_flat_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "HOME UNIT")]))
full$sale_flat_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "GROUP HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "VILLA HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "TOWN HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "FLAT")]))
full$sale_flat_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$sale_flat[which(full$PROP_CLA == "PLEX")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "APARTMENT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "HOME UNIT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "GROUP HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "VILLA HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "TOWN HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "FLAT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "PLEX")]))
full$land_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "HOUSE")]))
full$land_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "APARTMENT")]))
full$land_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "HOME UNIT")]))
full$land_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "GROUP HOUSE")]))
full$land_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "VILLA HOUSE")]))
full$land_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "TOWN HOUSE")]))
full$land_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "FLAT")]))
full$land_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "PLEX")]))
full$house_size_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "APARTMENT")]))
full$house_size_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "HOME UNIT")]))
full$house_size_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "GROUP HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "VILLA HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "TOWN HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "FLAT")]))
full$house_size_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "PLEX")]))
full$price_ratio = log(full$sale_flat_pre/full$sale_flat)
full$price_ratio_z = scale(full$price_ratio)
full$land_ratio = log(full$sale_flat/full$LAND_ARE)
full$land_ratio_z = scale(full$land_ratio)
full$land_ratio_pre = log(full$sale_flat_pre/full$LAND_ARE)
full$land_ratio_pre_z = scale(full$land_ratio_pre)
full$house_ratio = log(full$sale_flat/full$AREA_HSE)
full$house_ratio_z = scale(full$house_ratio)
full$house_ratio_pre = log(full$sale_flat_pre/full$AREA_HSE)
full$house_ratio_pre_z = scale(full$house_ratio_pre)
full$house_land_ratio = log(full$AREA_HSE/full$LAND_ARE)
full$house_land_ratio_z = scale(full$house_land_ratio)
full$sale_flat_z_pool = scale(log(full$sale_flat))
full$sale_flat_pre_z_pool = scale(log(full$sale_flat_pre))
full$land_z_pool = scale(log(full$LAND_ARE))
full$house_size_z_pool = scale(log(full$AREA_HSE))
#density plots
temp_plot = data.frame(log_sale_flat = log(full$sale_flat), log_sale_flat_pre = log(full$sale_flat), log_land = log(full$LAND_ARE), log_house_size = log(full$AREA_HSE), PROP_CLA = full$PROP_CLA)
#temp = temp_plot
#temp$PROP_CLA = "ALL"
#temp_plot = rbind(temp_plot, temp)
sale = ggplot(temp_plot, aes(x=log_sale_flat, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Price")
ggplotly(sale)
sale_pre = ggplot(temp_plot, aes(x=log_sale_flat_pre, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5)
ggplotly(sale_pre)
land = ggplot(temp_plot, aes(x=log_land, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Land Size")
ggplotly(land)
house = ggplot(temp_plot, aes(x=log_house_size, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Floor area")
ggplotly(house)
legend = get_legend(sale_pre) # need to delete legend position, save legend, then hide legend.
grid.arrange(sale, land, house, legend, ncol = 2, nrow = 2, widths = c(2.5, 2.5), heights = c(2.5, 2.5))
#pool RMSE(0.1801248, 0.1962826) nobs = 156800 154708
#zzr_zscore = full[-which(full$sale_flat_z_pool >=2.24 | full$sale_flat_z_pool <=-2.24),]
#zzr_zscore = zzr_zscore[-which(zzr_zscore$sale_flat_pre_z_pool >=2.24 | zzr_zscore$sale_flat_pre_z_pool <=-2.24),]
#no pool RMSE() nobs = 157092 155053
zzr_zscore = full[-which(full$sale_flat_z >=2.57 | full$sale_flat_z <=-2.57),]
zzr_zscore = zzr_zscore[-which(zzr_zscore$sale_flat_pre_z >=2.57 | zzr_zscore$sale_flat_pre_z <=-2.57),]
zzr_zscore = zzr_zscore[-which(zzr_zscore$land_z >=2.57 | zzr_zscore$land_z <=-2.57),]
zzr_zscore = zzr_zscore[-which(zzr_zscore$house_size_z >=2.57 | zzr_zscore$house_size_z <=-2.57),]
View(zzr_zscore)
log(0.5)
full = improved_data
full = full %>%
filter(full$quarter_num > 106) #2003:60; 2010:86; 2015:106.
full = full %>%
filter(full$numrooms > 0)
full = full %>%
filter(full$MULTI2 == 0)
full = full[-which(full$quarter_num_pre<=0),]
full = full %>%
filter(full$YEAR_BUI <= full$year)
full = full %>%
filter(full$SALE1 > 0)
full = full[-which(!is.na(full$DATE2) & full$SALE2 == 0),]
#there are na land area, check by google they are 11116 and 10336 squared meters.
#only use the lines for starting from 2010.
#full$LAND_ARE[which(full$LAND_ARE == 0 & full$ST_NO == "31       ")] = 10336
#full$LAND_ARE[which(full$LAND_ARE == 0 & full$ST_NO == "33       ")] = 11116
full$BEDS[which(full$BEDS == 0)] = NA
full$BATHS[which(full$BATHS == 0)] = NA
#full$numrooms[which(full$numrooms == 0)] = NA
#full$cars[which(full$cars == 0)] = NA
full$LAND_ARE[which(log(full$LAND_ARE) < 0)] = NA
#full$LAND_ARE[which(full$d_strata == 1)] = NA
full$YEAR_BUI[which(full$YEAR_BUI == 0)] = NA
full$AREA_HSE[which(log(full$AREA_HSE) < 0)] = NA
full$AREA_HSE[which(full$AREA_HSE == full$LAND_ARE)] = NA
full$SALE2[which(full$quarter_num_pre <= 60)] = NA
#full$d_strata[which(full$d_strata == 1)] = "strata"
#full$d_strata[which(full$d_strata == 0)] = "nonstrata"
full$sale_flat = NA
full$sale_flat_pre = NA
#flat by median price
for (i in 86:129) {
full$sale_flat[which(full$quarter_num == i)] = full$SALE1[which(full$quarter_num == i)]/abs$index[i]
}
for (i in 61:129) {
full$sale_flat_pre[which(full$quarter_num_pre == i)] = full$SALE2[which(full$quarter_num_pre == i)]/abs$index[i]
}
full$sale_flat_pre[which(full$YEAR_BUI>full$year_pre)] = NA
full$quarter_num_pre[which(full$YEAR_BUI>full$year_pre)] = NA
full$SALE2[which(full$YEAR_BUI>full$year_pre)] = NA
full$SALE2[which(full$SALE2 == 0)] = NA
full$DATE2[which(full$YEAR_BUI>full$year_pre)] = NA
full$sale_flat_z = NA
full$sale_flat_pre_z = NA
full$land_z = NA
full$house_size_z = NA
full$sale_flat_z_pool = NA
full$sale_flat_pre_z_pool = NA
full$land_z_pool = NA
full$house_size_z_pool = NA
full$sale_flat_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "APARTMENT")]))
full$sale_flat_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "HOME UNIT")]))
full$sale_flat_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "GROUP HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "VILLA HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "TOWN HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "FLAT")]))
full$sale_flat_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$sale_flat[which(full$PROP_CLA == "PLEX")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "APARTMENT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "HOME UNIT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "GROUP HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "VILLA HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "TOWN HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "FLAT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "PLEX")]))
full$land_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "HOUSE")]))
full$land_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "APARTMENT")]))
full$land_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "HOME UNIT")]))
full$land_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "GROUP HOUSE")]))
full$land_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "VILLA HOUSE")]))
full$land_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "TOWN HOUSE")]))
full$land_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "FLAT")]))
full$land_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "PLEX")]))
full$house_size_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "APARTMENT")]))
full$house_size_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "HOME UNIT")]))
full$house_size_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "GROUP HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "VILLA HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "TOWN HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "FLAT")]))
full$house_size_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "PLEX")]))
full$price_ratio = log(full$sale_flat_pre/full$sale_flat)
full$price_ratio_z = scale(full$price_ratio)
full$land_ratio = log(full$sale_flat/full$LAND_ARE)
full$land_ratio_z = scale(full$land_ratio)
full$land_ratio_pre = log(full$sale_flat_pre/full$LAND_ARE)
full$land_ratio_pre_z = scale(full$land_ratio_pre)
full$house_ratio = log(full$sale_flat/full$AREA_HSE)
full$house_ratio_z = scale(full$house_ratio)
full$house_ratio_pre = log(full$sale_flat_pre/full$AREA_HSE)
full$house_ratio_pre_z = scale(full$house_ratio_pre)
full$house_land_ratio = log(full$AREA_HSE/full$LAND_ARE)
full$house_land_ratio_z = scale(full$house_land_ratio)
full$sale_flat_z_pool = scale(log(full$sale_flat))
full$sale_flat_pre_z_pool = scale(log(full$sale_flat_pre))
full$land_z_pool = scale(log(full$LAND_ARE))
full$house_size_z_pool = scale(log(full$AREA_HSE))
temp = full
temp = full
temp_forest_test = data.frame(temp$sale_flat, temp$sale_flat_pre)
isoforest_test = isolation.forest(temp_forest_test, ntrees = 2000, ndim = 2, random_seed = 717)
#isoforest_test = isolation.forest(temp_forest_test, ntrees = 1000, ndim = 4, random_seed = 717, categ_split_type = "single_categ", penalize_range = TRUE, prob_pick_avg_gain = 0.75)
temp_forest_test$anomaly_score = predict(isoforest_test, temp_forest_test)
View(temp_forest_test)
temp = full
temp_forest_test = data.frame(temp$sale_flat, temp$sale_flat_pre)
isoforest_test = isolation.forest(temp_forest_test, ntrees = 2000, ndim = 1, random_seed = 717)
#isoforest_test = isolation.forest(temp_forest_test, ntrees = 1000, ndim = 4, random_seed = 717, categ_split_type = "single_categ", penalize_range = TRUE, prob_pick_avg_gain = 0.75)
temp_forest_test$anomaly_score = predict(isoforest_test, temp_forest_test)
View(temp_forest_test)
temp = full
temp_forest_test = data.frame(temp$sale_flat, temp$sale_flat_pre)
temp_forest_test = temp_forest_test %>%
filter(!is.na(temp_forest_test$temp.sale_flat_pre))
isoforest_test = isolation.forest(temp_forest_test, ntrees = 500, ndim = 2, random_seed = 717)
temp_forest_test$anomaly_score = predict(isoforest_test, temp_forest_test)
View(zzr_zscore)
View(temp_forest_test)
temp = full
temp_forest_test = data.frame(log(temp$sale_flat), log(temp$sale_flat_pre))
temp = full
temp_forest_test = data.frame(log(temp$sale_flat), log(temp$sale_flat_pre))
temp_forest_test = temp_forest_test %>%
filter(!is.na(temp_forest_test$log.temp.sale_flat_pre.))
isoforest_test = isolation.forest(temp_forest_test, ntrees = 1000, ndim = 2, random_seed = 717)
temp_forest_test$anomaly_score = predict(isoforest_test, temp_forest_test)
View(temp_forest_test)
exp(11.055)
exp(11.073)
exp(12.69)
#density plots
#temp_plot = data.frame(log_sale_flat = log(full$sale_flat), log_sale_flat_pre = log(full$sale_flat), log_land = log(full$LAND_ARE), log_house_size = log(full$AREA_HSE), PROP_CLA = full$PROP_CLA)
#sale = ggplot(temp_plot, aes(x=log_sale_flat, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Price")
#ggplotly(sale)
#sale_pre = ggplot(temp_plot, aes(x=log_sale_flat_pre, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5)
#ggplotly(sale_pre)
#land = ggplot(temp_plot, aes(x=log_land, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Land Size")
#ggplotly(land)
#house = ggplot(temp_plot, aes(x=log_house_size, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Floor area")
#ggplotly(house)
#legend = get_legend(sale_pre) # need to delete legend position, save legend, then hide legend.
#grid.arrange(sale, land, house, legend, ncol = 2, nrow = 2, widths = c(2.5, 2.5), heights = c(2.5, 2.5))
zzr_zscore = full[-which(full$sale_flat_z >=2.57 | full$sale_flat_z <=-2.57),]
zzr_zscore = zzr_zscore[-which(zzr_zscore$sale_flat_pre_z >=2.57 | zzr_zscore$sale_flat_pre_z <=-2.57),]
zzr_zscore = zzr_zscore[-which(zzr_zscore$land_z >=2.57 | zzr_zscore$land_z <=-2.57),]
zzr_zscore = zzr_zscore[-which(zzr_zscore$house_size_z >=2.57 | zzr_zscore$house_size_z <=-2.57),]
View(zzr_zscore)
table(zzr_zscore$BEDS)
View(zzr_zscore)
write.csv(zzr_zscore, "./fullsample_2015_2020q3_157634.csv")
full = improved_data
full = full %>%
filter(full$quarter_num > 106) #2003:60; 2010:86; 2015:106.
full = full %>%
filter(full$numrooms > 0)
full = full %>%
filter(full$MULTI2 == 0)
full = full[-which(full$quarter_num_pre<=0),]
full = full %>%
filter(full$YEAR_BUI <= full$year)
full = full %>%
filter(full$SALE1 > 0)
full = full[-which(!is.na(full$DATE2) & full$SALE2 == 0),]
#there are na land area, check by google they are 11116 and 10336 squared meters.
#only use the lines for starting from 2010.
#full$LAND_ARE[which(full$LAND_ARE == 0 & full$ST_NO == "31       ")] = 10336
#full$LAND_ARE[which(full$LAND_ARE == 0 & full$ST_NO == "33       ")] = 11116
full$BEDS[which(full$BEDS == 0)] = NA
full$BATHS[which(full$BATHS == 0)] = NA
#full$numrooms[which(full$numrooms == 0)] = NA
#full$cars[which(full$cars == 0)] = NA
full$LAND_ARE[which(log(full$LAND_ARE) < 0)] = NA
#full$LAND_ARE[which(full$d_strata == 1)] = NA
full$YEAR_BUI[which(full$YEAR_BUI == 0)] = NA
full$AREA_HSE[which(log(full$AREA_HSE) < 0)] = NA
full$AREA_HSE[which(full$AREA_HSE == full$LAND_ARE)] = NA
full$SALE2[which(full$quarter_num_pre <= 60)] = NA
#full$d_strata[which(full$d_strata == 1)] = "strata"
#full$d_strata[which(full$d_strata == 0)] = "nonstrata"
full$sale_flat = NA
full$sale_flat_pre = NA
#flat by median price
for (i in 86:129) {
full$sale_flat[which(full$quarter_num == i)] = full$SALE1[which(full$quarter_num == i)]/abs$index[i]
}
for (i in 61:129) {
full$sale_flat_pre[which(full$quarter_num_pre == i)] = full$SALE2[which(full$quarter_num_pre == i)]/abs$index[i]
}
full$sale_flat_pre[which(full$YEAR_BUI>full$year_pre)] = NA
full$quarter_num_pre[which(full$YEAR_BUI>full$year_pre)] = NA
full$SALE2[which(full$YEAR_BUI>full$year_pre)] = NA
full$SALE2[which(full$SALE2 == 0)] = NA
full$DATE2[which(full$YEAR_BUI>full$year_pre)] = NA
full$sale_flat_z = NA
full$sale_flat_pre_z = NA
full$land_z = NA
full$house_size_z = NA
full$sale_flat_z_pool = NA
full$sale_flat_pre_z_pool = NA
full$land_z_pool = NA
full$house_size_z_pool = NA
full$sale_flat_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "APARTMENT")]))
full$sale_flat_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "HOME UNIT")]))
full$sale_flat_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "GROUP HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "VILLA HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "TOWN HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "FLAT")]))
full$sale_flat_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$sale_flat[which(full$PROP_CLA == "PLEX")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "APARTMENT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "HOME UNIT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "GROUP HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "VILLA HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "TOWN HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "FLAT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "PLEX")]))
full$land_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "HOUSE")]))
full$land_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "APARTMENT")]))
full$land_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "HOME UNIT")]))
full$land_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "GROUP HOUSE")]))
full$land_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "VILLA HOUSE")]))
full$land_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "TOWN HOUSE")]))
full$land_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "FLAT")]))
full$land_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "PLEX")]))
full$house_size_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "APARTMENT")]))
full$house_size_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "HOME UNIT")]))
full$house_size_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "GROUP HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "VILLA HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "TOWN HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "FLAT")]))
full$house_size_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "PLEX")]))
full$price_ratio = log(full$sale_flat_pre/full$sale_flat)
full$price_ratio_z = scale(full$price_ratio)
full$land_ratio = log(full$sale_flat/full$LAND_ARE)
full$land_ratio_z = scale(full$land_ratio)
full$land_ratio_pre = log(full$sale_flat_pre/full$LAND_ARE)
full$land_ratio_pre_z = scale(full$land_ratio_pre)
full$house_ratio = log(full$sale_flat/full$AREA_HSE)
full$house_ratio_z = scale(full$house_ratio)
full$house_ratio_pre = log(full$sale_flat_pre/full$AREA_HSE)
full$house_ratio_pre_z = scale(full$house_ratio_pre)
full$house_land_ratio = log(full$AREA_HSE/full$LAND_ARE)
full$house_land_ratio_z = scale(full$house_land_ratio)
full$sale_flat_z_pool = scale(log(full$sale_flat))
full$sale_flat_pre_z_pool = scale(log(full$sale_flat_pre))
full$land_z_pool = scale(log(full$LAND_ARE))
full$house_size_z_pool = scale(log(full$AREA_HSE))
library(dplyr)
library(tidyr)
library(stringr)
library(foreign)
library(lubridate)
library(ggplot2)
library(isotree)
library(ggpubr)
library(gridExtra)
library(plotly)
full = improved_data
full = full %>%
filter(full$quarter_num > 106) #2003:60; 2010:86; 2015:106.
full = full %>%
filter(full$numrooms > 0)
full = full %>%
filter(full$MULTI2 == 0)
full = full[-which(full$quarter_num_pre<=0),]
full = full %>%
filter(full$YEAR_BUI <= full$year)
full = full %>%
filter(full$SALE1 > 0)
full = full[-which(!is.na(full$DATE2) & full$SALE2 == 0),]
#there are na land area, check by google they are 11116 and 10336 squared meters.
#only use the lines for starting from 2010.
#full$LAND_ARE[which(full$LAND_ARE == 0 & full$ST_NO == "31       ")] = 10336
#full$LAND_ARE[which(full$LAND_ARE == 0 & full$ST_NO == "33       ")] = 11116
full$BEDS[which(full$BEDS == 0)] = NA
full$BATHS[which(full$BATHS == 0)] = NA
#full$numrooms[which(full$numrooms == 0)] = NA
#full$cars[which(full$cars == 0)] = NA
full$LAND_ARE[which(log(full$LAND_ARE) < 0)] = NA
#full$LAND_ARE[which(full$d_strata == 1)] = NA
full$YEAR_BUI[which(full$YEAR_BUI == 0)] = NA
full$AREA_HSE[which(log(full$AREA_HSE) < 0)] = NA
full$AREA_HSE[which(full$AREA_HSE == full$LAND_ARE)] = NA
full$SALE2[which(full$quarter_num_pre <= 60)] = NA
#full$d_strata[which(full$d_strata == 1)] = "strata"
#full$d_strata[which(full$d_strata == 0)] = "nonstrata"
full$sale_flat = NA
full$sale_flat_pre = NA
#flat by median price
for (i in 86:129) {
full$sale_flat[which(full$quarter_num == i)] = full$SALE1[which(full$quarter_num == i)]/abs$index[i]
}
for (i in 61:129) {
full$sale_flat_pre[which(full$quarter_num_pre == i)] = full$SALE2[which(full$quarter_num_pre == i)]/abs$index[i]
}
full$sale_flat_pre[which(full$YEAR_BUI>full$year_pre)] = NA
full$quarter_num_pre[which(full$YEAR_BUI>full$year_pre)] = NA
full$SALE2[which(full$YEAR_BUI>full$year_pre)] = NA
full$SALE2[which(full$SALE2 == 0)] = NA
full$DATE2[which(full$YEAR_BUI>full$year_pre)] = NA
full$sale_flat_z = NA
full$sale_flat_pre_z = NA
full$land_z = NA
full$house_size_z = NA
full$sale_flat_z_pool = NA
full$sale_flat_pre_z_pool = NA
full$land_z_pool = NA
full$house_size_z_pool = NA
full$sale_flat_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "APARTMENT")]))
full$sale_flat_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "HOME UNIT")]))
full$sale_flat_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "GROUP HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "VILLA HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$sale_flat[which(full$PROP_CLA == "TOWN HOUSE")]))
full$sale_flat_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$sale_flat[which(full$PROP_CLA == "FLAT")]))
full$sale_flat_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$sale_flat[which(full$PROP_CLA == "PLEX")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "APARTMENT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "HOME UNIT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "GROUP HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "VILLA HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "TOWN HOUSE")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "FLAT")]))
full$sale_flat_pre_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$sale_flat_pre[which(full$PROP_CLA == "PLEX")]))
full$land_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "HOUSE")]))
full$land_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "APARTMENT")]))
full$land_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "HOME UNIT")]))
full$land_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "GROUP HOUSE")]))
full$land_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "VILLA HOUSE")]))
full$land_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "TOWN HOUSE")]))
full$land_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "FLAT")]))
full$land_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$LAND_ARE[which(full$PROP_CLA == "PLEX")]))
full$house_size_z[which(full$PROP_CLA == "HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "APARTMENT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "APARTMENT")]))
full$house_size_z[which(full$PROP_CLA == "HOME UNIT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "HOME UNIT")]))
full$house_size_z[which(full$PROP_CLA == "GROUP HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "GROUP HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "VILLA HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "VILLA HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "TOWN HOUSE")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "TOWN HOUSE")]))
full$house_size_z[which(full$PROP_CLA == "FLAT")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "FLAT")]))
full$house_size_z[which(full$PROP_CLA == "PLEX")] = scale(log(full$AREA_HSE[which(full$PROP_CLA == "PLEX")]))
full$price_ratio = log(full$sale_flat_pre/full$sale_flat)
full$price_ratio_z = scale(full$price_ratio)
full$land_ratio = log(full$sale_flat/full$LAND_ARE)
full$land_ratio_z = scale(full$land_ratio)
full$land_ratio_pre = log(full$sale_flat_pre/full$LAND_ARE)
full$land_ratio_pre_z = scale(full$land_ratio_pre)
full$house_ratio = log(full$sale_flat/full$AREA_HSE)
full$house_ratio_z = scale(full$house_ratio)
full$house_ratio_pre = log(full$sale_flat_pre/full$AREA_HSE)
full$house_ratio_pre_z = scale(full$house_ratio_pre)
full$house_land_ratio = log(full$AREA_HSE/full$LAND_ARE)
full$house_land_ratio_z = scale(full$house_land_ratio)
full$sale_flat_z_pool = scale(log(full$sale_flat))
full$sale_flat_pre_z_pool = scale(log(full$sale_flat_pre))
full$land_z_pool = scale(log(full$LAND_ARE))
full$house_size_z_pool = scale(log(full$AREA_HSE))
#density plots
#temp_plot = data.frame(log_sale_flat = log(full$sale_flat), log_sale_flat_pre = log(full$sale_flat), log_land = log(full$LAND_ARE), log_house_size = log(full$AREA_HSE), PROP_CLA = full$PROP_CLA)
#sale = ggplot(temp_plot, aes(x=log_sale_flat, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Price")
#ggplotly(sale)
#sale_pre = ggplot(temp_plot, aes(x=log_sale_flat_pre, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5)
#ggplotly(sale_pre)
#land = ggplot(temp_plot, aes(x=log_land, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Land Size")
#ggplotly(land)
#house = ggplot(temp_plot, aes(x=log_house_size, color = PROP_CLA, fill = PROP_CLA)) + geom_density(alpha = 0.5) + theme(legend.position = "none") + labs(x="log Floor area")
#ggplotly(house)
#legend = get_legend(sale_pre) # need to delete legend position, save legend, then hide legend.
#grid.arrange(sale, land, house, legend, ncol = 2, nrow = 2, widths = c(2.5, 2.5), heights = c(2.5, 2.5))
zzr_zscore = full[-which(full$sale_flat_z >=2.57 | full$sale_flat_z <=-2.57),]
zzr_zscore = zzr_zscore[-which(zzr_zscore$sale_flat_pre_z >=2.57 | zzr_zscore$sale_flat_pre_z <=-2.57),]
#zzr_zscore = zzr_zscore[-which(zzr_zscore$land_z >=2.57 | zzr_zscore$land_z <=-2.57),]
#zzr_zscore = zzr_zscore[-which(zzr_zscore$house_size_z >=2.57 | zzr_zscore$house_size_z <=-2.57),]
#model_expert = zzr_zscore[which(zzr_zscore$anomaly_score<=0.5),]
model_expert = zzr_zscore
model_expert$d_pool = 0
model_expert$d_pool[which(model_expert$POOL == "B/G  ")] = 1
model_expert$d_pool[which(model_expert$POOL == "A/G  ")] = 1
model_expert$d_tile = 0
model_expert$d_tile[which(model_expert$ROOF == "TILE  ")] = 1
model_expert$d_brick = 0
model_expert$d_brick[which(model_expert$WALL == "BRICK ")] = 1
model_expert$LA_DESC = as.factor(model_expert$LA_DESC)
model_expert$PROP_CLA = as.factor(model_expert$PROP_CLA)
model_expert$logprice = log(model_expert$SALE1)
model_expert$age = model_expert$year - model_expert$YEAR_BUI
write.csv(model_expert, "./fullsample_2015_2020q3_162237_cleanpriceonly.csv")
View(full_data)
View(model_expert)
View(full_data)
which(full_data$PIN == 11175362)
full_data[which(full_data$PIN == 11175362),]
full_data[which(full_data$PIN == 11178662),]
full_data[which(full_data$PIN == 1122971),]
full_data[which(full_data$PIN == 326389),]
full_data[which(full_data$PIN == 339906,]
full_data[which(full_data$PIN == 339906),]
View(full_data)
table(full$LA_DESC)
table(full_data$LA_DESC)
temp = full_data[which(full_data$DATE1>20150000)]
temp = full_data[which(full_data$DATE1>20150000),]
table(temp$LA_DESC)
temp = full_data[which(full_data$LA_DESC == "PERTH CITY COUNCIL       ")]
temp = full_data[which(full_data$LA_DESC == "PERTH CITY COUNCIL       "),]
View(temp)
View(full)
View(temp)
temp = full_data[which(full_data$SUBURB == "EAST PERTH"),]
temp = full_data[which(full_data$SUBURB == "EAST PERTH               "),]
View(temp)
View(full)
temp = full_data[which(full_data$LA_DESC == "PERTH CITY COUNCIL       "),]
