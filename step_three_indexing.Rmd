---
title: "step_two_indexing"
author: "Zhuoran"
date: "17/11/2021"
output: html_document
---


#libraries
```{r}
library(foreign)
library(dplyr)
library(lubridate)
library(gbm)
library(pdp)
library(doParallel)
library(foreach)
library(ggplot2)
```


#import data
```{r}
full_data = read.csv("./data/raw_data_2004_2020_RPPI.csv")[-1]

full_data$LA_DESC = as.factor(full_data$LA_DESC)
full_data$PROP_CLA = as.factor(full_data$PROP_CLA)
full_data$submarket = as.factor(full_data$submarket)
full_data$logprice = log(full_data$SALE1)
```


#prepare data for modeling
```{r}
model = data.frame(logprice = model_train$logprice,
                   quarter_num = model_train$quarter_num, 
                   LAND_ARE = model_train$LAND_ARE, 
                   AREA_HSE = model_train$AREA_HSE, 
                   age = model_train$age, 
                   BEDS = model_train$BEDS,
                   BATHS = model_train$BATHS, 
                   DINING = model_train$DINING, 
                   KITCHEN = model_train$KITCHEN, 
                   FAMILY = model_train$FAMILY, 
                   STUDY = model_train$STUDY, 
                   GAMES = model_train$GAMES, 
                   LOUNGE = model_train$LOUNGE, 
                   MEALS = model_train$MEALS, 
                   carpark = model_train$carpark, 
                   LA_DESC = model_train$LA_DESC, 
                   PROP_CLA = model_train$PROP_CLA, 
                   centlong = model_train$centlong, 
                   centlat = model_train$centlat, 
                   TENCRT = model_train$TENCRT,
                   d_pool = model_train$d_pool, 
                   d_brick = model_train$d_brick, 
                   d_tile = model_train$d_tile,
                   submarket = model_train$submarket)
```


#indexing full data process
```{r}
set.seed(717)
gbm_full = gbm(logprice ~ quarter_num + LAND_ARE + AREA_HSE + age + BEDS + BATHS + DINING + KITCHEN + FAMILY + STUDY + GAMES + LOUNGE + MEALS + carpark + LA_DESC + PROP_CLA + centlong + centlat + d_pool + d_brick + d_tile + TENCRT + submarket, data = model, distribution = "gaussian", n.trees = 2000, interaction.depth = 14, shrinkage = 0.05, n.minobsinnode = 15, bag.fraction = 0.5) #distribution = "laplace", if use laplace or MAE, two or more dimensional pdp generates the same predict numbers. Thus, gaussian (MSE) could be better. And then, paper one, the difference is negligible.


#partial dependence plot: just quarter number
set.seed(717)
pdp_quarters = partial(object = gbm_full,
                       train = model,
                       pred.var = "quarter_num",
                       n.trees = 2000,
                       pred.grid = data.frame(quarter_num = 1:max(model$quarter_num)))


#partial dependence plot: quarter number and submarket
set.seed(717)
pdp_quarters_submarket = partial(object = gbm_full,
                       train = model,
                       pred.var = c("quarter_num", "submarket"),
                       n.trees = 2000,
                       pred.grid = data.frame(quarter_num = sort(rep(1:max(model$quarter_num), 5)), submarket = c("inner","northeast","northwest","southeast","southwest")))


#partial dependence plot: quarter number and property class
set.seed(717)
pdp_quarters_class = partial(object = gbm_full,
                       train = model,
                       pred.var = c("quarter_num", "PROP_CLA"),
                       n.trees = 2000,
                       pred.grid = data.frame(quarter_num = sort(rep(1:max(model$quarter_num), 20)), PROP_CLA = c("APARTMENT HO", "DETACHED HOU", "DUPLEX      ", "FLAT        ", "GROUP HOUSE ", "HOLIDAY UNIT", "HOME UNIT   ", "HOUSE       ", "HOUSE - FLAT", "HOUSE - GRAN", "HOUSE - LAND", "HOUSE - UNIT", "PATIO HOUSE ", "QUADRUPLEX  ", "ROW HOUSE   ", "SEMI-DETACHE", "TERRACE HOUS", "TOWN HOUSE  ", "TRIPLEX     ", "VILLA HOUSE ")))


#partial dependence plot: quarter number, property class and submarket (something like this, could develop more, this one is more flexible)
set.seed(717)
pdp_quarters_submarket_class = partial(object = gbm_full,
                       train = model,
                       pred.var = c("quarter_num", "submarket", "PROP_CLA"),
                       n.trees = 2000,
                       pred.grid = data.frame(quarter_num = sort(rep(1:max(model$quarter_num), 100)), submarket = c(rep("inner", 20),rep("northeast", 20),rep("northwest", 20),rep("southeast", 20),rep("southwest", 20)), PROP_CLA = c("APARTMENT HO", "DETACHED HOU", "DUPLEX      ", "FLAT        ", "GROUP HOUSE ", "HOLIDAY UNIT", "HOME UNIT   ", "HOUSE       ", "HOUSE - FLAT", "HOUSE - GRAN", "HOUSE - LAND", "HOUSE - UNIT", "PATIO HOUSE ", "QUADRUPLEX  ", "ROW HOUSE   ", "SEMI-DETACHE", "TERRACE HOUS", "TOWN HOUSE  ", "TRIPLEX     ", "VILLA HOUSE ")))
```


#simply construct rppi, reference period is financial year 2011-2012
```{r}
baseline = mean(pdp_quarters[31:34,2])
pdp_quarters$index = exp(pdp_quarters$yhat - baseline) * 100
pdp_quarters_submarket$index = exp(pdp_quarters_submarket$yhat - baseline) * 100
pdp_quarters_class$index = exp(pdp_quarters_class$yhat - baseline) * 100
pdp_quarters_submarket_class$index = exp(pdp_quarters_submarket_class$yhat - baseline) * 100


ggplot(pdp_quarters, aes(quarter_num, index)) + geom_line()
ggplot(pdp_quarters_submarket, aes(quarter_num, index, color = submarket)) + geom_line()
ggplot(pdp_quarters_class, aes(quarter_num, index, color = PROP_CLA)) + geom_line()
```




#indexing rolling windows process
```{r}
#prepare windows for rolling process
for (i in 1:61) {
  temp_train = model[which(model$quarter_num <= (7+i) & model$quarter_num >= i),]
  
  assign(paste0("train_window_", i), temp_train)
}


#rolling window 8 quarters
for(i in 1:61){
  model_window = get(paste0("train_window_",i))
  
  #model in window
  set.seed(717)
  gbm_window = gbm(logprice ~ quarter_num + LAND_ARE + AREA_HSE + age + BEDS + BATHS + DINING + KITCHEN + FAMILY + STUDY + GAMES + LOUNGE + MEALS + carpark + LA_DESC + PROP_CLA + centlong + centlat + d_pool + d_brick + d_tile + TENCRT + submarket, data = model_window, distribution = "gaussian", n.trees = 2000, interaction.depth = 14, shrinkage = 0.05, n.minobsinnode = 15, bag.fraction = 0.5)
  
  #partial dependence plot: just 8 quarters
  set.seed(717)
  pdp_window = partial(object = gbm_window,
                       train = model_window,
                       pred.var = "quarter_num",
                       n.trees = 2000,
                       pred.grid = data.frame(quarter_num = 1:max(model_window$quarter_num)))
  
  #save model and pdp
  assign(paste0("gbm_window_",i), gbm_window)
  assign(paste0("pdp_window_",i), pdp_window)
  
  print(paste0("window ",i," is done."))
}
```
