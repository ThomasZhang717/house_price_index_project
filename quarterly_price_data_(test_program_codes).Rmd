---
title: "weekly_price_data"
author: "Zhuoran"
date: "3/18/2021"
output: html_document
---


```{r}
library(dplyr)
library(stringr)
library(foreign)
library(lubridate)
library(caret)
library(ranger)
library(gbm)
library(pdp)
library(solitude)
library(ggplot2)
```


#read house price
```{r}
house_price = read.csv("./full_data_improved_geo.csv")
```


#read data
```{r}
improved_data = house_price
improved_data$YEAR_BUI[which(improved_data$YEAR_BUI == 2103)] = 2013
improved_data$YEAR_BUI[which(improved_data$YEAR_BUI == 2300)] = 2009
improved_data$BEDS[which(improved_data$BEDS == -5)] = 5
improved_data$DATE1 = ymd(improved_data$DATE1)
```


#improved property data
```{r}
improved_data$cars = improved_data$CARPRT_A + improved_data$CARPRT_D + improved_data$CARPRT_U + improved_data$GARAGE_A  + improved_data$GARAGE_D  + improved_data$GARAGE_U
```


#identify needed property class
```{r}
#temp = data.frame(read.spss("./ThomasZhangFullPerthMetro_200920_duplicate checked.sav")) #1630028 test in origin

improved_data$d_residential = 0
improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "HOUS"))] = 1
improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "HOME UNIT"))] = 1
improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "FLAT"))] = 1
improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "DUPLEX"))] = 1
improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "APARTMENT"))] = 1
improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "TRIPLEX"))] = 1
improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "QUADRUPLEX"))] = 1
improved_data$d_residential[which(improved_data$PROP_CLA == "            ")] = 1
improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "DETA"))] = 1

improved_data$d_residential[which(str_detect(improved_data$PROP_CLA, "WAREHOUSE"))] = 0


improved_data_model_back = improved_data %>%
  filter(improved_data$DATE1 > 19880630) #1233578

improved_data_model = improved_data %>%
  filter(improved_data$DATE1 > 19880630) 

improved_data_model_back = improved_data_model_back %>%
  filter(improved_data_model_back$d_residential == 1)

improved_data_model = improved_data_model %>%
  filter(improved_data_model$d_residential == 1)

improved_data_model$DATE1 = ymd(improved_data_model$DATE1)

improved_data_model$numrooms = improved_data_model$BEDS + improved_data_model$DINING + improved_data_model$KITCHEN + improved_data_model$FAMILY + improved_data_model$GAMES + improved_data_model$MEALS + improved_data_model$LOUNGE + improved_data_model$STUDY + improved_data_model$BATHS + improved_data_model$ENSUITE

improved_data_model$bb_ration = improved_data_model$BATHS/improved_data_model$BEDS


improved_data_model_back$numrooms = improved_data_model_back$BEDS + improved_data_model_back$DINING + improved_data_model_back$KITCHEN + improved_data_model_back$FAMILY + improved_data_model_back$GAMES + improved_data_model_back$MEALS + improved_data_model_back$LOUNGE + improved_data_model_back$STUDY + improved_data_model_back$BATHS + improved_data_model_back$ENSUITE

improved_data_model_back$bb_ration = improved_data_model_back$BATHS/improved_data_model_back$BEDS


improved_data_model$DATE1 = ymd(improved_data_model$DATE1)
improved_data_model$quarter = quarter(improved_data_model$DATE1)
improved_data_model$year = year(improved_data_model$DATE1)
improved_data_model$quarter_num = (improved_data_model$year - 1988)*4 + improved_data_model$quarter -2
```


#test quarterly (just a test)
```{r}
temp = createDataPartition(house_price$X, p = 0.1)
temp_model = house_price[temp$Resample1,]
temp_model_test = house_price[-temp$Resample1,]
temp_model$DATE1 = ymd(temp_model$DATE1)
temp_model$quarter = quarter(temp_model$DATE1)
temp_model$year = year(temp_model$DATE1)
temp_model$quarter_num = (temp_model$year - 1989)*4 + temp_model$quarter

temp_model_test$DATE1 = ymd(temp_model_test$DATE1)
temp_model_test$quarter = quarter(temp_model_test$DATE1)
temp_model_test$year = year(temp_model_test$DATE1)
temp_model_test$quarter_num = (temp_model_test$year - 1989)*4 + temp_model_test$quarter


randforest_test = ranger(logprice ~ Centlat + Centlong + quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN, data = temp_model, mtry = 5, splitrule = "variance")

pd_impute = partial(object = randforest_test,
             train = temp_model[sample(1:nrow(temp_model), replace = TRUE), ],
             pred.var = "quarter_num",
             pred.grid = data.frame(quarter_num = 1:max(temp_model$quarter_num)))


temp_pd = pd_impute
temp_pd$diff = temp_pd$yhat - temp_pd$yhat[1]
temp_pd$exp_diff = exp(temp_pd$diff)
temp_pd$median = 0
for (i in 1:124) {
  temp_pd$median[i] = median(temp_model$SALE1[which(temp_model$quarter_num == i)])
}
temp_pd$med_index = temp_pd$median/temp_pd$median[1]

temp_pd$cs_rf[1] = 1
temp_pd$cs_rf[2:124] = imputation_price$ti

#8 quarters rolling
for (i in 8:124) {
  temp_rolling = temp_model[which(temp_model$quarter_num < (i+1) & temp_model$quarter_num > (i-8)), ]
  randforest_test = ranger(logprice ~ Centlat + Centlong + quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN, data = temp_rolling, mtry = 5, splitrule = "variance")
  
  temp_pd_impute = partial(object = randforest_test,
             train = temp_rolling[sample(1:nrow(temp_rolling), replace = TRUE), ],
             pred.var = "quarter_num",
             pred.grid = data.frame(quarter_num = (max(temp_rolling$quarter_num)-7):max(temp_rolling$quarter_num)))
  assign(paste0("rolling_", i, "_q8"), temp_pd_impute)
  print(i)
}
#4 quarters rolling
for (i in 4:124) {
  temp_rolling = temp_model[which(temp_model$quarter_num < (i+1) & temp_model$quarter_num > (i-4)), ]
  randforest_test = ranger(logprice ~ Centlat + Centlong + quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN, data = temp_rolling, mtry = 5, splitrule = "variance")
  
  temp_pd_impute = partial(object = randforest_test,
             train = temp_rolling[sample(1:nrow(temp_rolling), replace = TRUE), ],
             pred.var = "quarter_num",
             pred.grid = data.frame(quarter_num = (max(temp_rolling$quarter_num)-3):max(temp_rolling$quarter_num)))
  assign(paste0("rolling_", i), temp_pd_impute)
  print(i)
}
# 2 quarters rolling
for (i in 2:124) {
  temp_rolling = temp_model[which(temp_model$quarter_num < (i+1) & temp_model$quarter_num > (i-2)), ]
  randforest_test = ranger(logprice ~ Centlat + Centlong + quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN, data = temp_rolling, mtry = 5, splitrule = "variance")
  
  temp_pd_impute = partial(object = randforest_test,
             train = temp_rolling[sample(1:nrow(temp_rolling), replace = TRUE), ],
             pred.var = "quarter_num",
             pred.grid = data.frame(quarter_num = (max(temp_rolling$quarter_num)-1):max(temp_rolling$quarter_num)))
  assign(paste0("rolling_", i, "_adjacent"), temp_pd_impute)
  print(i)
}

#adjacent index
rolling_adjacent = data.frame()
for (i in 2:124) {
  temp = get(paste0("rolling_", i, "_adjacent"))
  rolling_adjacent = rbind(rolling_adjacent, temp)
}
rolling_adjacent$diff = NA
for (i in seq(2,244,2)) {
  rolling_adjacent$diff[i] = (rolling_adjacent$yhat[i] + rolling_adjacent$yhat[i])/2 - rolling_adjacent$yhat[1]
}
rolling_adjacent$diff[246] = rolling_adjacent$yhat[246] - rolling_adjacent$yhat[1]
temp_pd$rolling_adjacent = 1
for (i in seq(2,246,2)) {
  temp_pd$rolling_adjacent[1+i/2] = exp(rolling_adjacent$diff[i])
}


#trial one possible
rolling_index = rolling_4
for (i in 2:121) {
  temp_list = data.frame(window = i:(i+3))
  temp_list = data.frame(window = temp_list$window[which(temp_list$window > 3)])
  temp_list = temp_list$window[which(temp_list$window < 125)]
  n=1
  for (j in temp_list) {
    assign(paste0("temp_", n), get(paste0("rolling_", j)))
    n=n+1
  }
  if(length(temp_list) == 4 & i != 121){
    rolling_index[i+1,2] = mean(c(temp_2$yhat[4], temp_3$yhat[3], temp_4$yhat[2]))
    rolling_index[i+1,1] = mean(c(temp_2$quarter_num[4], temp_3$quarter_num[3], temp_4$quarter_num[2]))
  }
  if(length(temp_list) == 3){
    rolling_index[i+1,2] = mean(c(temp_1$yhat[4], temp_2$yhat[3], temp_3$yhat[2]))
    rolling_index[i+1,1] = mean(c(temp_1$quarter_num[4], temp_2$quarter_num[3], temp_3$quarter_num[2]))
  }
  if(length(temp_list) == 2){
    rolling_index[i+1,2] = mean(c(temp_1$yhat[3], temp_2$yhat[2]))
    rolling_index[i+1,1] = mean(c(temp_1$quarter_num[3], temp_2$quarter_num[2]))
  }
  if(length(temp_list) == 4 & i == 121){
    rolling_index[i+1,2] = mean(c(temp_2$yhat[4], temp_3$yhat[3], temp_4$yhat[2]))
    rolling_index[i+1,1] = mean(c(temp_2$quarter_num[4], temp_3$quarter_num[3], temp_4$quarter_num[2]))
    rolling_index[i+2,2] = mean(c(temp_3$yhat[2], temp_4$yhat[3]))
    rolling_index[i+2,1] = mean(c(temp_3$quarter_num[2], temp_4$quarter_num[3]))
    rolling_index[i+3,2] = temp_4$yhat[4]
    rolling_index[i+3,1] = temp_4$quarter_num[4]
  }
}
rolling_index$exp_diff = exp(rolling_index$yhat - rolling_index$yhat[1])
temp_pd$rolling = rolling_index$exp_diff



#trial two(this one is more efficient than trial one): quarter 8  rolling
rolling_index_q8 = rolling_8_q8
for (i in 2:124) {
  temp_list = data.frame(window = i:(i+7))
  temp_list = data.frame(window = temp_list$window[which(temp_list$window > 7)])
  temp_list = temp_list$window[which(temp_list$window < 125)]
  temp = data.frame()
  for (j in temp_list) {
    temp = rbind(temp, get(paste0("rolling_", j, "_q8")))
  }
  rolling_index_q8[i,1] = i
  rolling_index_q8[i,2] = mean(temp$yhat[which(temp$quarter_num == i)])
}
rolling_index_q8$exp_diff = exp(rolling_index_q8$yhat - rolling_index_q8$yhat[1])


temp_pd$rolling_q8 = rolling_index_q8$exp_diff

ggplot(data = temp_pd) + geom_line(aes(x=quarter_num, y = exp_diff), color = "red") + geom_line(aes(x=quarter_num, y = med_index), color = "black") + geom_line(aes(x=quarter_num, y = cs_rf), color = "blue") + geom_line(aes(x=quarter_num, y = rolling), color = "green") + geom_line(aes(quarter_num, rolling_q8), color = "pink")



resale_test = temp_model_test %>%
  filter(temp_model_test$SALE2 > 0)
resale_test = resale_test %>%
  filter(resale_test$SALE2>9999)
resale_test = resale_test %>%
  filter(resale_test$SALE2<5000001)
resale_test$DATE2 = ymd(resale_test$DATE2)
resale_test$quarter_pre = quarter(resale_test$DATE2)
resale_test$year_pre = year(resale_test$DATE2)
resale_test$quarter_num_pre = (resale_test$year_pre - 1989)*4 + resale_test$quarter_pre
resale_test = resale_test %>%
  filter(resale_test$quarter_num_pre > 0)

resale_test$prediction_index = 0
for(i in 1:388701){
  resale_test$prediction_index[i] = resale_test$SALE2[i]/temp_pd$exp_diff[which(temp_pd$quarter_num == resale_test$quarter_num_pre[i])]*temp_pd$exp_diff[which(temp_pd$quarter_num == resale_test$quarter_num[i])]
}

resale_test$prediction_index_rolling = 0
for(i in 1:388701){
  resale_test$prediction_index_rolling[i] = resale_test$SALE2[i]/temp_pd$rolling_q8[which(temp_pd$quarter_num == resale_test$quarter_num_pre[i])]*temp_pd$exp_diff[which(temp_pd$quarter_num == resale_test$quarter_num[i])]
}

resale_test$prediction_index_adjacent = 0
for(i in 1:388701){
  resale_test$prediction_index_adjacent[i] = resale_test$SALE2[i]/temp_pd$rolling_adjacent[which(temp_pd$quarter_num == resale_test$quarter_num_pre[i])]*temp_pd$exp_diff[which(temp_pd$quarter_num == resale_test$quarter_num[i])]
}

resale_test$prediction_index_med = 0
for(i in 1:388701){
  resale_test$prediction_index_med[i] = resale_test$SALE2[i]/temp_pd$med_index[which(temp_pd$quarter_num == resale_test$quarter_num_pre[i])]*temp_pd$exp_diff[which(temp_pd$quarter_num == resale_test$quarter_num[i])]
}
```


#test lga and class
```{r}
#pick out classes
temp = improved_data_model[which(improved_data_model$PROP_CLA == "HOUSE       "),]

temp = rbind(temp ,improved_data_model[which(improved_data_model$PROP_CLA == "APARTMENT HO"),])
temp = rbind(temp ,improved_data_model[which(improved_data_model$PROP_CLA == "DUPLEX UNIT "),])
temp = rbind(temp ,improved_data_model[which(improved_data_model$PROP_CLA == "FLAT        "),])
temp = rbind(temp ,improved_data_model[which(improved_data_model$PROP_CLA == "GROUP HOUSE "),])
temp = rbind(temp ,improved_data_model[which(improved_data_model$PROP_CLA == "HOME UNIT   "),])
temp = rbind(temp ,improved_data_model[which(improved_data_model$PROP_CLA == "TOWN HOUSE  "),])
temp = rbind(temp ,improved_data_model[which(improved_data_model$PROP_CLA == "VILLA HOUSE "),])
temp = rbind(temp ,improved_data_model[which(improved_data_model$PROP_CLA == "            "),])
temp$PROP_CLA[which(temp$PROP_CLA == "            ")] = "Other"

improved_data_model = temp
```


#identify outliers (done)
```{r}
#price outlier and zscore
for (i in 1988:2020) {
  temp = improved_data_model[which(year(improved_data_model$DATE1) == i),]
  temp$logprice = log(temp$SALE1)
  temp = temp %>%
    filter(temp$logprice>=0)
  temp_iso = isolationForest$new(sample_size = nrow(temp), num_trees = 500)
  iso_fit = temp_iso$fit(dataset = data.frame(temp$logprice))
  price = temp_iso$predict(data.frame(temp$logprice))
  temp$price_outlier = price$anomaly_score
  temp$price_zscore = (temp$logprice - mean(temp$logprice))/sd(temp$logprice)
  assign(paste0("temp_", i, sep = ""), temp)
  print(i)
}

for (i in 1988:2020) {
  temp = get(paste0("temp_", i, sep=""))
  print(summary(temp$SALE1[which(temp$price_outlier <= 0.65)]))
  print(summary(temp$SALE1[which(abs(temp$price_zscore) <= 3)]))
  print(length(which(temp$price_outlier <= 0.65))/nrow(temp))
  print(length(which(abs(temp$price_zscore) <= 3))/nrow(temp))
  print(i)
}

```


#land area outlier identify  (Done, looks good)
```{r}
#land area and zscore
for (i in 1988:2020) {
  temp = improved_data_model[which(year(improved_data_model$DATE1) == i),]
  temp$logland = log(temp$LAND_ARE)
  temp = temp %>%
    filter(temp$logland>=0)
  temp_iso = isolationForest$new(sample_size = nrow(temp), num_trees = 500)
  iso_fit = temp_iso$fit(dataset = data.frame(temp$LAND_ARE))
  land = temp_iso$predict(data.frame(temp$LAND_ARE))
  temp$land_outlier = land$anomaly_score
  temp$land_zscore = (temp$logland - mean(temp$logland))/sd(temp$logland)
  assign(paste0("temp_", i, "_land", sep = ""), temp)
  print(i)
}

#land 0.63
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, "_land", sep=""))
  print(summary(temp$LAND_ARE[which(temp$land_outlier <= 0.63)]))
  print(summary(temp$LAND_ARE[which(abs(temp$land_zscore) <= 3)]))
  print(length(which(temp$land_outlier <= 0.63))/nrow(temp))
  print(length(which(abs(temp$land_zscore) <= 3))/nrow(temp))
  print(i)
}

```


#house area outlier identify (done, looks good)
```{r}
#land area and zscore
for (i in 1988:2020) {
  temp = improved_data_model[which(year(improved_data_model$DATE1) == i),]
  temp$loghouse = log(temp$AREA_HSE)
  temp = temp %>%
    filter(temp$loghouse>=0)
  temp_iso = isolationForest$new(sample_size = nrow(temp), num_trees = 500)
  iso_fit = temp_iso$fit(dataset = data.frame(temp$AREA_HSE))
  land = temp_iso$predict(data.frame(temp$AREA_HSE))
  temp$house_outlier = land$anomaly_score
  temp$house_zscore = (temp$loghouse - mean(temp$loghouse))/sd(temp$loghouse)
  assign(paste0("temp_", i, "_house", sep = ""), temp)
  print(i)
}

#house area 
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, "_house", sep=""))
  print(summary(temp$AREA_HSE[which(temp$house_outlier <= 0.708)]))
  print(summary(temp$AREA_HSE[which(abs(temp$house_zscore) <= 3)]))
  print(length(which(temp$house_outlier <= 0.708))/nrow(temp))
  print(length(which(abs(temp$house_zscore) <= 3))/nrow(temp))
  print(i)
}

```


#outlier graph 
```{r}
#price 0.65; land 0.63, house size 0.70.
outliergraph = data.frame()
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, sep=""))
  temp = temp %>%
    filter(temp$price_outlier <= 0.65)
  outliergraph = rbind(outliergraph, temp)
}
outliergraph_zscore = data.frame()
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, sep=""))
  temp = temp %>%
    filter(abs(temp$price_zscore) <= 3)
  outliergraph_zscore = rbind(outliergraph_zscore, temp)
}
ggplot(outliergraph, aes(x=logprice)) + geom_histogram(binwidth = 0.1) + xlim(8,16)
ggplot(outliergraph_zscore, aes(x=logprice)) + geom_histogram(binwidth = 0.1) + xlim(8,16)


outliergraph = data.frame()
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, "_land", sep=""))
  temp = temp %>%
    filter(temp$land_outlier <= 0.63)
  outliergraph = rbind(outliergraph, temp)
}
outliergraph_zscore = data.frame()
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, "_land", sep=""))
  temp = temp %>%
    filter(abs(temp$land_zscore) <= 3)
  outliergraph_zscore = rbind(outliergraph_zscore, temp)
}
ggplot(outliergraph, aes(x=logland)) + geom_histogram(binwidth = 0.1) + xlim(2,12)
ggplot(outliergraph_zscore, aes(x=logland)) + geom_histogram(binwidth = 0.1) + xlim(2,12)


outliergraph = data.frame()
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, "_house", sep=""))
  temp = temp %>%
    filter(temp$house_outlier <= 0.708)
  outliergraph = rbind(outliergraph, temp)
}
outliergraph_zscore = data.frame()
for (i in 1988:2020) {
  temp = get(paste0("temp_", i,  "_house", sep=""))
  temp = temp %>%
    filter(abs(temp$house_zscore) <= 3)
  outliergraph_zscore = rbind(outliergraph_zscore, temp)
}
ggplot(outliergraph, aes(x=loghouse)) + geom_histogram(binwidth = 0.1) + xlim(2,7)
ggplot(outliergraph_zscore, aes(x=loghouse)) + geom_histogram(binwidth = 0.1) + xlim(2,7)
```


#identify outliers all variables (every property is unique is hard to find outliers using all variables)
```{r}
#land area and zscore
for (i in 1988:2020) {
  temp = improved_data_model[which(year(improved_data_model$DATE1) == i),]
  temp$logland = log(temp$LAND_ARE)
  temp = temp %>%
    filter(temp$logland>=0)
  temp = temp %>%
    filter(temp$logprice>=0)
  temp = temp %>%
    filter(temp$YEAR_BUI > 1869)
  temp_iso = isolationForest$new(sample_size = nrow(temp))
  iso_fit = temp_iso$fit(dataset = data.frame(temp$logprice, temp$LAND_ARE, temp$YEAR_BUI, temp$BEDS, temp$BATHS, temp$DINING, temp$cars, temp$KITCHEN, temp$LA_DESC, temp$PROP_CLA))
  all = temp_iso$predict(data.frame(temp$logprice, temp$LAND_ARE, temp$YEAR_BUI, temp$BEDS, temp$BATHS, temp$DINING, temp$cars, temp$KITCHEN, temp$LA_DESC, temp$PROP_CLA))
  temp$all_outlier = all$anomaly_score
  assign(paste0("temp_", i, "_all", sep = ""), temp)
  print(i)
}

#all this one not work
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, "_all", sep=""))
  print(summary(temp$LAND_ARE[which(temp$all_outlier <= 0.5814)]))
  print(summary(temp$SALE1[which(temp$all_outlier <= 0.5814)]))
  print(length(which(temp$all_outlier <= 0.5814))/nrow(temp))
  print(i)
}
```



#model test (rookie just clean price)
```{r}
#rookie set
model = data.frame()
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, sep=""))
  temp = temp %>%
    filter(temp$price_outlier <= 0.65)
  model = rbind(model, temp)
}

for (i in 1988:2020) {
  temp = get(paste0("temp_", i, sep=""))
  temp = temp %>%
    filter(abs(temp$price_zscore) <= 3)
  model = rbind(model, temp)
}

set.seed(717)
temp_list = createDataPartition(model$X, p = 0.8)
temp_model = model[temp_list$Resample1,]
temp_model_test = model[-temp_list$Resample1,]

set.seed(717)
randforest_test = ranger(logprice ~ quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + LA_DESC + PROP_CLA, data = temp_model, mtry = 5, splitrule = "variance")

randforest_test_factor = ranger(logprice ~ quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + LA_DESC + PROP_CLA, data = temp_boost, mtry = 5, splitrule = "variance")

set.seed(717)
temp_pd_impute = partial(object = randforest_test,
                         train = temp_model[sample(1:nrow(temp_model), replace = TRUE), ],
                         pred.var = "quarter_num",
                         pred.grid = data.frame(quarter_num = 1:max(temp_model$quarter_num)))
set.seed(717)
pred_q_lga = data.frame(quarter_num = c(seq(1,8)), LA_DESC = c("ARMADALE                 ")) #, "BASSENDEAN               ", "BAYSWATER                ", "BELMONT                  ", "CAMBRIDGE                 ", "CANNING                  ", "CLAREMONT                ", "COCKBURN                 ", "COTTESLOE                 ", "EAST FREMANTLE           ", "FREMANTLE                ", "GOSNELLS                 ", "JOONDALUP                ", "KALAMUNDA                ", "KWINANA                  ", "MELVILLE                 ", "MOSMAN PARK              ", "MUNDARING                ", "NEDLANDS                 ", "PEPPERMINT GROVE         ", "PERTH CITY COUNCIL       ", "ROCKINGHAM               ", "SERPENTINE-JARRAHDALE    ", "SOUTH PERTH              ", "STIRLING                 ", "SUBIACO                  ", "SWAN                     ", "VICTORIA PARK            ", "VINCENT                  ", "WANNEROO                 "))
pred_q_lga = data.frame(quarter_num = c(seq(1,8)), LA_DESC = c("VICTORIA PARK            "))
pred_q_class = data.frame(quarter_num = c(rep(1,2), rep(2,2)), PROP_CLA = c("APARTMENT HO", "HOUSE       "))
pred_q_class = data.frame(quarter_num = c(seq(1, 8)), PROP_CLA = c("HOUSE       "))#, "DUPLEX UNIT ", "FLAT        ", "GROUP HOUSE ", "HOME UNIT   ", "HOUSE       ", "TOWN HOUSE  ", "VILLA HOUSE "))
temp_pd_impute_two = partial(object = randforest_test_factor,
                             train = temp_model[sample(1:nrow(temp_model), replace = TRUE), ],
                             pred.var = c("quarter_num", "PROP_CLA"),
                             pred.grid = pred_q_class)
temp_house = temp_model[which(temp_model$PROP_CLA == "HOUSE       "),]
temp_house = temp_house %>%
  filter(temp_house$quarter_num < 9)
temp_pd_impute_house = partial(object = randforest_test,
                             train = temp_house[sample(1:nrow(temp_house), replace = TRUE), ],
                             pred.var = c("quarter_num", "PROP_CLA"),
                             pred.grid = pred_q_class)

temp_pd_impute_two_lga = partial(object = randforest_test,
                             train = temp_model[sample(1:nrow(temp_model), replace = TRUE), ],
                             pred.var = c("quarter_num", "LA_DESC"),
                             pred.grid = pred_q_lga)

temp_pd_impute_two_vic = partial(object = randforest_test,
                             train = temp_model[sample(1:nrow(temp_model), replace = TRUE), ],
                             pred.var = c("quarter_num", "LA_DESC"),
                             pred.grid = pred_q_lga)

temp = predict(randforest_test_factor, temp_boost_test)
RMSE(temp$predictions, temp_boost_test$logprice)
RMSE(randforest_test_factor$predictions, temp_model$logprice)
```


#test gbm
```{r}
set.seed(717)
temp_boost = temp_model
temp_boost$LA_DESC = as.factor(temp_boost$LA_DESC)
temp_boost$PROP_CLA = as.factor(temp_boost$PROP_CLA)
temp_boost_test = temp_model_test
temp_boost_test$LA_DESC = as.factor(temp_boost_test$LA_DESC)
temp_boost_test$PROP_CLA = as.factor(temp_boost_test$PROP_CLA)
boost_test = gbm(logprice ~ quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + LA_DESC + PROP_CLA, data = temp_boost, distribution = "gaussian", n.trees = 1000, interaction.depth = 12, shrinkage = 0.1)

set.seed(717)
temp_pd_impute_b = partial(object = boost_test,
                         train = temp_boost[sample(1:nrow(temp_boost), replace = TRUE), ],
                         pred.var = "quarter_num",
                         n.trees = 1000,
                         pred.grid = data.frame(quarter_num = 1:max(temp_boost$quarter_num)))

pred_q_lga = data.frame(quarter_num = c(sort(rep(1:129, 30))), LA_DESC = c("ARMADALE                 ", "BASSENDEAN               ", "BAYSWATER                ", "BELMONT                  ", "CAMBRIDGE                 ", "CANNING                  ", "CLAREMONT                ", "COCKBURN                 ", "COTTESLOE                 ", "EAST FREMANTLE           ", "FREMANTLE                ", "GOSNELLS                 ", "JOONDALUP                ", "KALAMUNDA                ", "KWINANA                  ", "MELVILLE                 ", "MOSMAN PARK              ", "MUNDARING                ", "NEDLANDS                 ", "PEPPERMINT GROVE         ", "PERTH CITY COUNCIL       ", "ROCKINGHAM               ", "SERPENTINE-JARRAHDALE    ", "SOUTH PERTH              ", "STIRLING                 ", "SUBIACO                  ", "SWAN                     ", "VICTORIA PARK            ", "VINCENT                  ", "WANNEROO                 "))

pred_q_class = data.frame(quarter_num = c(sort(rep(1:129, 9))), PROP_CLA = c("APARTMENT HO", "DUPLEX UNIT ", "FLAT        ", "GROUP HOUSE ", "HOME UNIT   ", "HOUSE       ", "TOWN HOUSE  ", "VILLA HOUSE ", "Other"))

temp_pd_impute_b_lga = partial(object = boost_test,
                         train = temp_boost[sample(1:nrow(temp_boost), replace = TRUE), ],
                         pred.var = c("quarter_num", "LA_DESC"),
                         n.trees = 1000,
                         pred.grid = pred_q_lga)


temp_pd_impute_b_class = partial(object = boost_test,
                         train = temp_boost[sample(1:nrow(temp_boost), replace = TRUE), ],
                         pred.var = c("quarter_num", "PROP_CLA"),
                         n.trees = 1000,
                         pred.grid = pred_q_class)


temp = predict(boost_test, temp_boost_test, n.trees = 1000)
RMSE(temp, temp_boost_test$logprice)
RMSE(boost_test$fit, temp_boost$logprice)
```


#chained random forest can't do suburbs and class, but gbm can do
```{r}
for (i in 1:129) {
  temp = temp_boost[which(temp_boost$quarter_num == i),]
  write.csv(temp, paste0("./quarterly/window_", i, "_quarterly",".csv", sep = ""))
}

temp = read.csv(paste0("./quarterly/window_", 1, "_quarterly",".csv", sep = ""))[-1]
temp = rbind(temp, read.csv(paste0("./quarterly/window_", 2, "_quarterly",".csv", sep = ""))[-1])

set.seed(717)
randforest_chain = ranger(logprice ~ quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + LA_DESC + PROP_CLA, data = temp, mtry = 5, splitrule = "variance")

temp$LA_DESC = as.factor(temp$LA_DESC)
temp$PROP_CLA = as.factor(temp$PROP_CLA)
set.seed(717)
boost_chain = gbm(logprice ~ quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + LA_DESC + PROP_CLA, data = temp, distribution = "gaussian", n.trees = 1000, interaction.depth = 12, shrinkage = 0.1)

set.seed(717)
temp_pd_impute_chain = partial(object = randforest_chain,
                         train = temp[sample(1:nrow(temp), replace = TRUE), ],
                         pred.var = "quarter_num",
                         pred.grid = data.frame(quarter_num = 1:max(temp$quarter_num)))

temp_pd_impute_chain_b = partial(object = boost_chain,
                         train = temp[sample(1:nrow(temp), replace = TRUE), ],
                         pred.var = "quarter_num",
                         n.trees = 1000,
                         pred.grid = data.frame(quarter_num = 1:max(temp$quarter_num)))

set.seed(717)
temp_pd_impute_chain = partial(object = randforest_chain,
                         train = temp[sample(1:nrow(temp), replace = TRUE), ],
                         pred.var = c("quarter_num", "PROP_CLA"),
                         pred.grid = pred_q_class)
temp_pd_impute_chain_b = partial(object = boost_chain,
                         train = temp[sample(1:nrow(temp), replace = TRUE), ],
                         pred.var = c("quarter_num", "LA_DESC"),
                         n.trees = 1000,
                         pred.grid = pred_q_lga)
pred_q_lga = data.frame(quarter_num = c(rep(1,30), rep(2,30)), LA_DESC = c("ARMADALE                 ", "BASSENDEAN               ", "BAYSWATER                ", "BELMONT                  ", "CAMBRIDGE                 ", "CANNING                  ", "CLAREMONT                ", "COCKBURN                 ", "COTTESLOE                 ", "EAST FREMANTLE           ", "FREMANTLE                ", "GOSNELLS                 ", "JOONDALUP                ", "KALAMUNDA                ", "KWINANA                  ", "MELVILLE                 ", "MOSMAN PARK              ", "MUNDARING                ", "NEDLANDS                 ", "PEPPERMINT GROVE         ", "PERTH CITY COUNCIL       ", "ROCKINGHAM               ", "SERPENTINE-JARRAHDALE    ", "SOUTH PERTH              ", "STIRLING                 ", "SUBIACO                  ", "SWAN                     ", "VICTORIA PARK            ", "VINCENT                  ", "WANNEROO                 "))
pred_q_class = data.frame(quarter_num = c(rep(1,9),  rep(2,9)), PROP_CLA = c("APARTMENT HO", "DUPLEX UNIT ", "FLAT        ", "GROUP HOUSE ", "HOME UNIT   ", "HOUSE       ", "TOWN HOUSE  ", "VILLA HOUSE ", "Other"))
```


#median quarters
```{r}
temp_median = data.frame()
for(i in 1:129){
  temp = temp_boost[which(temp_boost$quarter_num == i),]
  temp_median[i,1] = i
  temp_median[i,2] = median(temp$logprice)
  print(median(temp$logprice))
}
colnames(temp_median) = c("quarter_num", "yhat")
temp_median$exp_diff = exp(temp_median$yhat - temp_median$yhat[1])
```


#plot index
```{r}
#sample
index_plot = data.frame(temp_pd_impute$quarter_num, temp_pd_impute$exp_diff, temp_pd_impute_b$exp_diff, temp_median$exp_diff)
colnames(index_plot) = c("Quanters", "RandomForest", "Boosting", "Median")


ggplot(data = index_plot) + geom_line(aes(x=Quanters, y = RandomForest), color = "red") + geom_line(aes(x=Quanters, y = Boosting), color = "black") + geom_line(aes(x=Quanters, y = Median), color = "blue")


index_plot = data.frame(temp_pd_impute$quarter_num, temp_pd_impute$exp_diff_61, temp_pd_impute_b$exp_diff_61, temp_median$exp_diff_61)
colnames(index_plot) = c("Quanters", "RandomForest", "Boosting", "Median")

ggplot(data = index_plot) + geom_line(aes(x=Quanters, y = RandomForest), color = "red") + geom_line(aes(x=Quanters, y = Boosting), color = "black") + geom_line(aes(x=Quanters, y = Median), color = "blue")


temp_pd_impute$exp_diff_set = exp(temp_pd_impute$yhat - 11)
temp_pd_impute_b$exp_diff_set = exp(temp_pd_impute_b$yhat - 11)
temp_median$exp_diff_set = exp(temp_median$yhat - 11)

index_plot = data.frame(temp_pd_impute$quarter_num, temp_pd_impute$exp_diff_set, temp_pd_impute_b$exp_diff_set, temp_median$exp_diff_set)
colnames(index_plot) = c("Quanters", "RandomForest", "Boosting", "Median")

ggplot(data = index_plot) + geom_line(aes(x=Quanters, y = RandomForest), color = "red") + geom_line(aes(x=Quanters, y = Boosting), color = "black") + geom_line(aes(x=Quanters, y = Median), color = "blue")


index_plot = data.frame(temp_pd_impute$quarter_num, temp_pd_impute$yhat, temp_pd_impute_b$yhat, temp_median$yhat)
colnames(index_plot) = c("Quanters", "RandomForest", "Boosting", "Median")

ggplot(data = index_plot) + geom_line(aes(x=Quanters, y = RandomForest), color = "red") + geom_line(aes(x=Quanters, y = Boosting), color = "black") + geom_line(aes(x=Quanters, y = Median), color = "blue")


#this one better
index_plot_one = temp_pd_impute
index_plot_one = rbind(index_plot_one, temp_pd_impute_b)
index_plot_one = rbind(index_plot_one, temp_median)
index_plot_one$method = c(rep("random forest", 129), rep("boosting", 129), rep("median", 129))

ggplot(data = index_plot_one, aes(quarter_num, yhat, colour = method)) + geom_line() + xlab("Quarters") + ylab("Log Price Prediction")

ggplot(data = index_plot_one, aes(quarter_num, exp_diff, colour = method)) + geom_line() + xlab("Quarters") + ylab("RPPI")

ggplot(data = index_plot_one, aes(quarter_num, exp_diff_61, colour = method)) + geom_line() + xlab("Quarters") + ylab("RPPI")

ggplot(data = index_plot_one, aes(quarter_num, exp_diff_set, colour = method)) + geom_line() + xlab("Quarters") + ylab("RPPI")



ggplot(data = temp_pd_impute_b_lga, aes(quarter_num, yhat, colour = LA_DESC)) + geom_line() + xlab("Quarter") + ylab("Log Price Prediction")


ggplot(data = temp_pd_impute_b_class, aes(quarter_num, yhat, colour = PROP_CLA)) + geom_line() + xlab("Quarter") + ylab("Log Price Prediction")
```


#construct expert dataset, clean all
```{r}
#expert set
model_expert = data.frame()
for (i in 1988:2020) {
  temp = get(paste0("temp_", i, sep=""))
  temp_land = get(paste0("temp_", i, "_land", sep=""))
  temp_housearea = get(paste0("temp_", i, "_house", sep=""))
  temp = merge(temp, temp_land, by = "X", all.x = TRUE)
  temp = merge(temp, temp_housearea, by = "X", all.x = TRUE)

  temp = temp[-which(temp$house_outlier > 0.708),]
  temp = temp[-which(temp$land_outlier > 0.63),]
  temp = temp[-which(temp$price_outlier > 0.65),]

  temp = temp[,c(1:90, 178:180, 268:270)]
  
  model_expert = rbind(model_expert, temp)
}
colnames(model_expert)[1:88] = colnames(model)[1:88]

model_expert = model_expert %>%
  filter(model_expert$numrooms > 0)
write.csv(model_expert, "./model_expert_pricelandhouseoutlier_0room.csv")
```


#expert model test (quarters: continuous number)
```{r}
model_expert = read.csv("./model_expert_pricelandhouseoutlier_0room.csv")[-1]
model_expert$LAND_ARE[which(model_expert$LAND_ARE == 0)] = NA
model_expert$AREA_HSE[which(model_expert$AREA_HSE == 0)] = NA
model_expert$YEAR_BUI[which(model_expert$YEAR_BUI < 1869)] = NA
model_expert$d_pool = 0
model_expert$d_pool[which(model_expert$POOL == "B/G  ")] = 1
model_expert$d_pool[which(model_expert$POOL == "A/G  ")] = 1


set.seed(717)
temp_list = createDataPartition(model_expert$X, p = 0.8)
temp_model = model_expert[temp_list$Resample1,]
temp_model_test = model_expert[-temp_list$Resample1,]



set.seed(717)
temp_boost = temp_model
temp_boost$LA_DESC = as.factor(temp_boost$LA_DESC)
temp_boost$PROP_CLA = as.factor(temp_boost$PROP_CLA)
temp_boost_test = temp_model_test
temp_boost_test$LA_DESC = as.factor(temp_boost_test$LA_DESC)
temp_boost_test$PROP_CLA = as.factor(temp_boost_test$PROP_CLA)

boost_test = gbm(logprice ~ quarter_num + LAND_ARE + AREA_HSE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + FAMILY + GAMES + MEALS + LOUNGE + STUDY + d_pool + LA_DESC + PROP_CLA, data = temp_boost, distribution = "gaussian", n.trees = 1000, interaction.depth = 12, shrinkage = 0.1)

#pdp_quaters
set.seed(717)
temp_pd_impute_b = partial(object = boost_test,
                         train = temp_boost[sample(1:nrow(temp_boost), replace = TRUE), ],
                         pred.var = "quarter_num",
                         n.trees = 1000,
                         pred.grid = data.frame(quarter_num = 1:max(temp_boost$quarter_num)))

#pdp_lgas
pred_q_lga = data.frame(quarter_num = c(sort(rep(1:129, 30))), LA_DESC = c("ARMADALE                 ", "BASSENDEAN               ", "BAYSWATER                ", "BELMONT                  ", "CAMBRIDGE                 ", "CANNING                  ", "CLAREMONT                ", "COCKBURN                 ", "COTTESLOE                 ", "EAST FREMANTLE           ", "FREMANTLE                ", "GOSNELLS                 ", "JOONDALUP                ", "KALAMUNDA                ", "KWINANA                  ", "MELVILLE                 ", "MOSMAN PARK              ", "MUNDARING                ", "NEDLANDS                 ", "PEPPERMINT GROVE         ", "PERTH CITY COUNCIL       ", "ROCKINGHAM               ", "SERPENTINE-JARRAHDALE    ", "SOUTH PERTH              ", "STIRLING                 ", "SUBIACO                  ", "SWAN                     ", "VICTORIA PARK            ", "VINCENT                  ", "WANNEROO                 "))

temp_pd_impute_b_lga = partial(object = boost_test,
                         train = temp_boost[sample(1:nrow(temp_boost), replace = TRUE), ],#replace could change to false, should be same
                         pred.var = c("quarter_num", "LA_DESC"),
                         n.trees = 1000,
                         pred.grid = pred_q_lga)

#pdp_property classes
pred_q_class = data.frame(quarter_num = c(sort(rep(1:129, 9))), PROP_CLA = c("APARTMENT HO", "DUPLEX UNIT ", "FLAT        ", "GROUP HOUSE ", "HOME UNIT   ", "HOUSE       ", "TOWN HOUSE  ", "VILLA HOUSE ", "Other"))

temp_pd_impute_b_class = partial(object = boost_test,
                         train = temp_boost[sample(1:nrow(temp_boost), replace = TRUE), ],
                         pred.var = c("quarter_num", "PROP_CLA"),
                         n.trees = 1000,
                         pred.grid = pred_q_class)


temp = predict(boost_test, temp_boost_test, n.trees = 1000)
RMSE(temp, temp_boost_test$logprice)
RMSE(boost_test$fit, temp_boost$logprice)

temp_pd_impute_b$exp_diff = exp(temp_pd_impute_b$yhat - temp_pd_impute_b$yhat[1])


temp_pd_impute_b$median = 0
for(i in 1:129){
  temp = model_expert[which(model_expert$quarter_num == i),]
  temp_pd_impute_b$median[i] = median(temp$logprice)
}

temp_pd_impute_b$median_exp_diff = exp(temp_pd_impute_b$median - temp_pd_impute_b$median[1])
```


#cross-section expert data
```{r}
for(i in 1:129){
  set.seed(717)
  temp = temp_boost[which(temp_boost$quarter_num == i),]

  boost = gbm(logprice ~ LAND_ARE + AREA_HSE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + FAMILY + GAMES + MEALS + LOUNGE + STUDY + d_pool + LA_DESC + PROP_CLA, data = temp, distribution = "gaussian", n.trees = 1000, interaction.depth = 12, shrinkage = 0.1)
  
  assign(paste0("boost_", i, sep = ""), boost)
  print(i)
}

#traditional fisher passchet layerstes index
temp_pd_impute_b_chain = data.frame()
for(i in 1:129){
  set.seed(717)
  temp = temp_boost[which(temp_boost$quarter_num == 63),]
  boost_temp = get(paste0("boost_", i, sep = ""))
  pred = predict(boost_temp, temp, n.trees = 1000)
  li = prod(exp(pred - temp$logprice)^(1/nrow(temp)))
  
  temp = temp_boost[which(temp_boost$quarter_num == i),]
  pred = predict(boost_63, temp, n.trees = 1000)
  pi = prod(exp(temp$logprice - pred)^(1/nrow(temp)))

  fi = sqrt(pi*li)
  temp_pd_impute_b_chain[i,1] = i
  temp_pd_impute_b_chain[i,2] = fi
  temp_pd_impute_b_chain[i,3] = li
  temp_pd_impute_b_chain[i,4] = pi
  print(i)
}

#chained index
temp_pd_impute_b_chain = data.frame(1,1,1,1)
for(i in 2:129){
  set.seed(717)
  temp_pre = temp_boost[which(temp_boost$quarter_num == i-1),]
  temp_post = temp_boost[which(temp_boost$quarter_num == i),]
  
  boost_temp_pre = get(paste0("boost_", i-1, sep = ""))
  boost_temp_post = get(paste0("boost_", i, sep = ""))
  
  
  pred_pre = predict(boost_temp_pre, temp_post, n.trees = 1000)
  pred_post = predict(boost_temp_post, temp_pre, n.trees = 1000)
  
  li = prod(exp(pred_post - temp_pre$logprice)^(1/nrow(temp_pre)))
  
  pi = prod(exp(temp_post$logprice - pred_pre)^(1/nrow(temp_post)))

  fi = sqrt(pi*li)
  temp_pd_impute_b_chain[i,1] = i
  temp_pd_impute_b_chain[i,2] = fi
  temp_pd_impute_b_chain[i,3] = li
  temp_pd_impute_b_chain[i,4] = pi
  print(i)
}
```


#moving windows (chained)
```{r}
for(i in 1:128){
  set.seed(717)
  temp = temp_boost[which(temp_boost$quarter_num == i | temp_boost$quarter_num == i+1),]

  boost = gbm(logprice ~ quarter_num + LAND_ARE + AREA_HSE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + FAMILY + GAMES + MEALS + LOUNGE + STUDY + d_pool + LA_DESC + PROP_CLA, data = temp, distribution = "gaussian", n.trees = 1000, interaction.depth = 12, shrinkage = 0.1)
  
  assign(paste0("boost_", i, "_chain", sep = ""), boost)
  print(i)
}

#patial dependence
temp_pd_impute_b_mw = data.frame()
for(i in 1:128){
  set.seed(717)
  temp = temp_boost[which(temp_boost$quarter_num == i | temp_boost$quarter_num == i+1),]
  
  temp_chain = partial(object = get(paste0("boost_", i, "_chain", sep = "")),
                       train = temp[sample(1:nrow(temp), replace = TRUE), ],
                       pred.var = "quarter_num",
                       n.trees = 1000,
                       pred.grid = data.frame(quarter_num = c(i,i+1)))
  
  temp_pd_impute_b_mw = rbind(temp_pd_impute_b_mw, temp_chain)
  
  print(i)
}


temp_pd_impute_b_mw_index = data.frame()
for(i in 1:128){
  temp_pd_impute_b_mw_index[i,1] = i
  temp_pd_impute_b_mw_index[i,2] = exp(temp_pd_impute_b_mw$yhat[2*i] - temp_pd_impute_b_mw$yhat[2*i-1])
  temp_pd_impute_b_mw_index[i,3] = prod(temp_pd_impute_b_mw_index$V2[1:i])
}

#quarter to quarter
temp_pd_impute_b_mw = data.frame(1,1,1)
for(i in 2:129){
  temp = temp_boost[which(temp_boost$quarter_num == i-1 | temp_boost$quarter_num == i),]
  
  boost = get(paste0("boost_", i-1, "_chain", sep = ""))
  
  temp_pd_impute_b_mw[i,1] = i
  temp_pd_impute_b_mw[i,2] = exp(mean(boost$fit[which(temp$quarter_num == i)]))/exp(mean(boost$fit[which(temp$quarter_num == i-1)]))
  
  temp_pd_impute_b_mw[i,3] = prod(temp_pd_impute_b_mw[1:i,2])
  
  print(i)
}

```


#sale price (gbm not works, have negative values)
```{r}
set.seed(717)
temp_boost = temp_model
temp_boost$LA_DESC = as.factor(temp_boost$LA_DESC)
temp_boost$PROP_CLA = as.factor(temp_boost$PROP_CLA)
temp_boost_test = temp_model_test
temp_boost_test$LA_DESC = as.factor(temp_boost_test$LA_DESC)
temp_boost_test$PROP_CLA = as.factor(temp_boost_test$PROP_CLA)

boost_test_sale = gbm(SALE1 ~ quarter_num + LAND_ARE + AREA_HSE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN + FAMILY + GAMES + MEALS + LOUNGE + STUDY + d_pool + LA_DESC + PROP_CLA, data = temp_boost, distribution = "gaussian", n.trees = 1000, interaction.depth = 12, shrinkage = 0.1)
```

#errors
```{r}
#continuous
prediction_continuous = data.frame(boost_test$fit, temp_boost$logprice, temp_boost$quarter_num)
prediction_continuous_test = data.frame(predict(boost_test, temp_boost_test, n.trees = 1000), temp_boost_test$logprice, temp_boost_test$quarter_num)
colnames(prediction_continuous) = c("pred", "real", "quarter_num")
colnames(prediction_continuous_test) = c("pred", "real", "quarter_num")

#adjacent
temp = temp_boost[which(temp_boost$quarter_num == 1 | temp_boost$quarter_num == 2),]
prediction_adjacent = data.frame(pred = boost_1_chain$fit[which(temp$quarter_num == 1)], real = temp$logprice[which(temp$quarter_num == 1)], quarter_num = temp$quarter_num[which(temp$quarter_num == 1)])

temp = temp_boost_test[which(temp_boost_test$quarter_num == 1 | temp_boost_test$quarter_num == 2),]
prediction_adjacent_test = data.frame(pred = predict(boost_1_chain, temp[which(temp$quarter_num == 1),], n.trees = 1000), real = temp$logprice[which(temp$quarter_num == 1)], quarter_num = temp$quarter_num[which(temp$quarter_num == 1)])
for (i in 2:128) {
  temp_pre = temp_boost[which(temp_boost$quarter_num == i-1 | temp_boost$quarter_num == i),]
  temp_post = temp_boost[which(temp_boost$quarter_num == i | temp_boost$quarter_num == i+1),]
  
  boost_temp_pre = get(paste0("boost_", i-1, "_chain", sep = ""))
  boost_temp_post = get(paste0("boost_", i, "_chain", sep = ""))
  
  temp = data.frame(
    pred = rowMeans(data.frame(boost_temp_pre$fit[which(temp_pre$quarter_num == i)], boost_temp_post$fit[which(temp_post$quarter_num == i)])),
    real = rowMeans(data.frame(temp_pre$logprice[which(temp_pre$quarter_num == i)], temp_post$logprice[which(temp_post$quarter_num == i)])),
    quarter_num = rowMeans(data.frame(temp_pre$quarter_num[which(temp_pre$quarter_num == i)], temp_post$quarter_num[which(temp_post$quarter_num == i)])))
  prediction_adjacent = rbind(prediction_adjacent, temp)

  
  temp_pre = temp_boost_test[which(temp_boost_test$quarter_num == i-1 | temp_boost_test$quarter_num == i),]
  temp_post = temp_boost_test[which(temp_boost_test$quarter_num == i | temp_boost_test$quarter_num == i+1),]
  
  temp = data.frame(
    pred = rowMeans(data.frame(predict(boost_temp_pre, temp_pre[which(temp_pre$quarter_num == i),], n.trees = 1000), predict(boost_temp_post, temp_post[which(temp_post$quarter_num == i),], n.trees = 1000))),
    real = rowMeans(data.frame(temp_pre$logprice[which(temp_pre$quarter_num == i)], temp_post$logprice[which(temp_post$quarter_num == i)])),
    quarter_num = rowMeans(data.frame(temp_pre$quarter_num[which(temp_pre$quarter_num == i)], temp_post$quarter_num[which(temp_post$quarter_num == i)])))
  prediction_adjacent_test = rbind(prediction_adjacent_test, temp)
}
temp_post = temp_boost[which(temp_boost$quarter_num == 128 | temp_boost$quarter_num == 129),]
boost_temp_post = get(paste0("boost_", 128, "_chain", sep = ""))
  
temp = data.frame(
  pred = boost_temp_post$fit[which(temp_post$quarter_num == 129)],
  real = temp_post$logprice[which(temp_post$quarter_num == 129)],
  quarter_num = temp_post$quarter_num[which(temp_post$quarter_num == 129)])
prediction_adjacent = rbind(prediction_adjacent, temp)

temp_post = temp_boost_test[which(temp_boost_test$quarter_num == 128 | temp_boost_test$quarter_num == 129),]
  
temp = data.frame(
  pred = predict(boost_temp_post, temp_post[which(temp_post$quarter_num == 129),], n.trees = 1000),
  real = temp_post$logprice[which(temp_post$quarter_num == 129)],
  quarter_num = temp_post$quarter_num[which(temp_post$quarter_num == 129)])
prediction_adjacent_test = rbind(prediction_adjacent_test, temp)

#cross section
prediction_cross = data.frame()
prediction_cross_test = data.frame()
for (i in 1:129) {
  boost_temp = get(paste0("boost_", i, sep = ""))
  temp = data.frame(pred = boost_temp$fit, real = temp_boost$logprice[which(temp_boost$quarter_num == i)], quarter_num = temp_boost$quarter_num[which(temp_boost$quarter_num == i)])
  prediction_cross = rbind(prediction_cross, temp)
  #print(RMSE(boost_temp$fit, temp_boost$logprice[which(temp_boost$quarter_num == i)]))
  
  temp = data.frame(pred = predict(boost_temp, temp_boost_test[which(temp_boost_test$quarter_num == i),], n.trees = 1000), real = temp_boost_test$logprice[which(temp_boost_test$quarter_num == i)], quarter_num = temp_boost_test$quarter_num[which(temp_boost_test$quarter_num == i)])
  prediction_cross_test = rbind(prediction_cross_test, temp)
  #print(RMSE(predict(boost_temp, temp_boost_test[which(temp_boost_test$quarter_num == i),], n.trees = 1000), temp_boost_test$logprice[which(temp_boost_test$quarter_num == i)]))
}
```


#index and graphs
```{r}
three_index = data.frame()
for (i in 1:129) {
  three_index[i,1] = exp(temp_pd_impute_b$yhat[i] - temp_pd_impute_b$yhat[63])
  if(i < 63){
    three_index[i,2] = 1/prod(temp_pd_impute_b_mw$X1.1[(i+1):63])
    three_index[i,3] = 1/prod(temp_pd_impute_b_chain$X1.1[(1+i):63])
  }
  else if(i > 63){
    three_index[i,2] = prod(temp_pd_impute_b_mw$X1.1[64:i])
    three_index[i,3] = prod(temp_pd_impute_b_chain$X1.1[64:i])
  }
  else{
    three_index[i,2] = 1
    three_index[i,3] = 1
  }
  three_index[i,4] = exp(temp_pd_impute_b$median[i] - temp_pd_impute_b$median[63])
}
colnames(three_index) = c("Continuous_quarters", "Adjacent_quarters", "Cross_section", "Median")

index_graph = data.frame()
index_graph[1:129,1] = 1:129
index_graph[1:129,2] = three_index$Continuous_quarters
index_graph[1:129,3] = "Continuous Quarters"

index_graph[130:258,1] = 1:129
index_graph[130:258,2] = three_index$Adjacent_quarters
index_graph[130:258,3] = "Adjacent Quarters"

index_graph[259:387,1] = 1:129
index_graph[259:387,2] = three_index$Cross_section
index_graph[259:387,3] = "Cross Section"

index_graph[388:516,1] = 1:129
index_graph[388:516,2] = three_index$Median
index_graph[388:516,3] = "Median"

colnames(index_graph) = c("quarter", "index", "method")

ggplot(index_graph, aes(x = quarter, y = index, group = method, color = method)) + geom_line()

```










































































































































#code backup
```{r}
#modeling the rolling windows
start_date = date("1989-01-01")
anchor_date = date("1989-01-08")
i = 1
while (anchor_date < date("2019-12-28")) {
  temp_train_data = house_price %>%
    filter(house_price$DATE1 < anchor_date)
  temp_train_data =  temp_train_data %>%
    filter(temp_train_data$DATE1 > start_date - 1)
  
  write.csv(temp_train_data, paste0("./weekly/window_", i, "_weekly",".csv", sep = ""))

  
  i = i + 1
  start_date =  start_date + 7
  anchor_date = anchor_date + 7
  print(anchor_date)
}

for (i in 1:124) {
  temp_train_data = house_price[which(house_price$quarter_num == i),]
  write.csv(temp_train_data, paste0("./quarterly/window_", i, "_quarterly",".csv", sep = ""))
}
```


#tune parameters weekly
```{r}
#models
for (i in 1:208) {
  train_data = read.csv(paste0("./weekly/window_", i, "_weekly.csv", sep = ""))
  train_data$age = year(train_data$DATE1) - train_data$YEAR_BUI
  #Random Forest
  set.seed(717) #need to set seed separately
  
  control = trainControl(method = 'repeatedcv', 
                       number = 10, 
                       repeats = 2,
                       search = "random",
                       verboseIter = TRUE)

  Randforest_model = train(logprice ~ LAND_ARE + Centlat + Centlong + age + cars + BEDS + BATHS + DINING + KITCHEN + FAMILY + GAMES + MEALS + LOUNGE + STUDY + TENCRT +  d_pool ,
                           data = train_data,
                           method = 'ranger',
                           tuneLength  = 10, 
                           trControl = control,
                           importance = "permutation")
  assign(paste0("rand_", i), Randforest_model)
  #save results
  print(paste0("Random Forest window ", i, " is done."))
}




for (i in 1:124) {
  train_data = read.csv(paste0("./quarterly/window_", i, "_quarterly.csv", sep = ""))
  #Random Forest
  randforest = ranger(logprice ~ Centlat + Centlong + quarter_num + LAND_ARE + YEAR_BUI + BEDS + BATHS + DINING + cars + KITCHEN, data = train_data, mtry = 5, splitrule = "variance")
  assign(paste0("rand_", i), randforest)
  #save results
  print(paste0("Random Forest window ", i, " is done."))
}
```



```{r}
imputation_price = data.frame()
#paasche
n=1
for(i in 2:124){
  temp = read.csv(paste0("./quarterly/window_", i, "_quarterly.csv", sep = ""))
  pre_t = predict(get(paste0("rand_", 1, sep="")), data = temp)
  pi = prod((exp(temp$logprice)/exp(pre_t$predictions))^(1/nrow(temp)))
  imputation_price[n,1] = pi
  print(n)
  n=n+1
}


#laspeyres
n=1
for(i in 2:124){
  temp = read.csv(paste0("./quarterly/window_", 1, "_quarterly.csv", sep = ""))
  pre_t = predict(get(paste0("rand_", i, sep="")), data = temp)
  li = prod((exp(pre_t$predictions)/exp(temp$logprice))^(1/nrow(temp)))
  imputation_price[n,2] = li
  print(n)
  n=n+1
}

colnames(imputation_price) = c("pi", "li")
imputation_price$ti = sqrt(imputation_price$pi * imputation_price$li)
```


#hpi
```{r}
imputation_price$hpi = 0
for(i in 1:nrow(imputation_price)){
  imputation_price$hpi[i] = prod(imputation_price$ti[1:i])
}

hpi = data.frame()
for(i in 1:4){
  for(j in 1:52){
    n = (i - 1) * 52 + j
    hpi[n,1] = 1989 + (i-1) + j*0.01
  }
}
hpi[1,2] = 1
hpi[2:208,2] = imputation_price$hpi
colnames(hpi) = c("weeks", "hpi")
```
