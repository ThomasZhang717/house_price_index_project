---
title: "step_two_prepare_data"
author: "Zhuoran"
date: "20/11/2021"
output: html_document
---


#libraries
```{r}
library(foreign)
library(dplyr)
library(lubridate)
library(gbm)
library(pdp)
library(doParallel)
library(foreach)
library(ggplot2)
```


#import data
```{r}
full_data = read.csv("./data/raw_data_2004_2020_RPPI.csv")[-1]

full_data$LA_DESC = as.factor(full_data$LA_DESC)
full_data$PROP_CLA = as.factor(full_data$PROP_CLA)
full_data$submarket = as.factor(full_data$submarket)
full_data$logprice = log(full_data$SALE1)
```


#mark transaction times of the same property
```{r}
#use parcel id to track properties, shared land properties may have the same land id, but parcel id is unique to each property
parcelid = data.frame(table(full_data$PARCEL_I))
colnames(parcelid) = c("PARCEL_I", "sale_freq")

full_data = left_join(full_data, parcelid, by = "PARCEL_I")

full_data = full_data[order(full_data$PARCEL_I),]
```


#prepare resale data
```{r}
model_resale = full_data[which(full_data$sale_freq > 1),]

model_resale = model_resale[order(model_resale$PARCEL_I, model_resale$DATE1),]

model_resale$train_test = "train"

for (i in 1:nrow(parcelid)){
  if (parcelid$sale_freq[i] > 2){
    set.seed(i)
    n = sample(1:(parcelid$sale_freq[i]-2), 1, replace = FALSE)
    temp = rep("train", parcelid$sale_freq[i])
    set.seed(i)
    temp[sample(1:parcelid$sale_freq[i], n, replace = FALSE)] = "test"
    model_resale$train_test[which(model_resale$PARCEL_I == parcelid$PARCEL_I[i])] = temp
  }
  print(i)
}

write.csv(model_resale, "./data/raw_data_2004_2020_RPPI_repeatsales.csv")
```


#save resale train data
```{r}
model_train_resale = model_resale %>%
  filter(model_resale$train_test == "train")

write.csv(model_train_resale, "./data/raw_data_2004_2020_RPPI_repeatsales_train.csv")
```


#prepare hedonic data
```{r}
model_test = model_resale %>%
  filter(model_resale$train_test == "test")

temp = model_test[,-100]

model_train_hedonic = setdiff(full_data, temp)

write.csv(model_train_hedonic, "./data/raw_data_2004_2020_RPPI_hedonic_train.csv")
write.csv(model_test, "./data/raw_data_2004_2020_RPPI_test.csv")
```