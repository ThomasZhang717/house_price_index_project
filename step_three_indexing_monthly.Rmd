---
title: "step_three_indexing_monthly"
author: "Zhuoran"
date: "03/12/2021"
output: html_document
---


#libraries
```{r}
library(foreign)
library(dplyr)
library(lubridate)
library(gbm)
library(pdp)
library(doParallel)
library(foreach)
library(ggplot2)
library(caret)
library(iml)
```


#hedonic indexing
#import data (if use train_test_split_backup, no need to run this)
```{r}
model_train_hedonic = read.csv("./data/raw_data_2004_2020_RPPI_hedonic_train.csv")[-1]

model_train_hedonic$LA_DESC = as.factor(model_train_hedonic$LA_DESC)
model_train_hedonic$PROP_CLA = as.factor(model_train_hedonic$PROP_CLA)
model_train_hedonic$submarket = as.factor(model_train_hedonic$submarket)
model_train_hedonic$logprice = log(model_train_hedonic$SALE1)
```


#add month (train & test)
```{r}
model_train_hedonic$month = month(model_train_hedonic$DATE1)
model_train_hedonic$month_num = 0
for (i in 2004:2020) {
  model_train_hedonic$month_num[which(model_train_hedonic$year_sale == i)] = model_train_hedonic$month[which(model_train_hedonic$year_sale == i)] + (i - 2004) * 12
}

model_test$month = month(model_test$DATE1)
model_test$month_num = 0
for (i in 2004:2020) {
  model_test$month_num[which(model_test$year_sale == i)] = model_test$month[which(model_test$year_sale == i)] + (i - 2004) * 12
}
```



#prepare data for modeling
```{r}
model = data.frame(logprice = model_train_hedonic$logprice,
                   month_num = model_train_hedonic$month_num, 
                   LAND_ARE = model_train_hedonic$LAND_ARE, 
                   AREA_HSE = model_train_hedonic$AREA_HSE, 
                   age = model_train_hedonic$age, 
                   BEDS = model_train_hedonic$BEDS,
                   BATHS = model_train_hedonic$BATHS, 
                   DINING = model_train_hedonic$DINING, 
                   KITCHEN = model_train_hedonic$KITCHEN, 
                   FAMILY = model_train_hedonic$FAMILY, 
                   STUDY = model_train_hedonic$STUDY, 
                   GAMES = model_train_hedonic$GAMES, 
                   LOUNGE = model_train_hedonic$LOUNGE, 
                   MEALS = model_train_hedonic$MEALS, 
                   carpark = model_train_hedonic$carpark, 
                   LA_DESC = model_train_hedonic$LA_DESC, 
                   PROP_CLA = model_train_hedonic$PROP_CLA, 
                   centlong = model_train_hedonic$centlong, 
                   centlat = model_train_hedonic$centlat, 
                   TENCRT = model_train_hedonic$TENCRT,
                   d_pool = model_train_hedonic$d_pool, 
                   d_brick = model_train_hedonic$d_brick, 
                   d_tile = model_train_hedonic$d_tile)
```


#indexing full data process
```{r}
set.seed(717)
gbm_full = gbm(logprice ~ month_num + LAND_ARE + AREA_HSE + age + BEDS + BATHS + DINING + KITCHEN + FAMILY + STUDY + GAMES + LOUNGE + MEALS + carpark + LA_DESC + PROP_CLA + centlong + centlat + d_pool + d_brick + d_tile + TENCRT, data = model, distribution = "laplace", n.trees = 2000, interaction.depth = 14, shrinkage = 0.05, n.minobsinnode = 15, bag.fraction = 0.5)


month_num = 1:204
LA_DESC = c("ARMADALE", "BASSENDEAN", "BAYSWATER", "BELMONT", "CAMBRIDGE", "CANNING", "CLAREMONT", "COCKBURN", "COTTESLOE", "EAST FREMANTLE", "FREMANTLE", "GOSNELLS", "JOONDALUP", "KALAMUNDA", "KWINANA", "MELVILLE", "MOSMAN PARK", "MUNDARING", "NEDLANDS", "PEPPERMINT GROVE", "PERTH CITY COUNCIL", "ROCKINGHAM", "SERPENTINE-JARRAHDALE", "SOUTH PERTH", "STIRLING", "SUBIACO", "SWAN", "VICTORIA PARK", "VINCENT", "WANNEROO")
PROP_CLA = c("APARTMENT HO", "DETACHED HOU", "DUPLEX", "FLAT", "GROUP HOUSE", "HOLIDAY UNIT", "HOME UNIT", "HOUSE", "HOUSE - FLAT", "HOUSE - GRAN", "HOUSE - LAND", "HOUSE - UNIT", "PATIO HOUSE", "QUADRUPLEX", "ROW HOUSE", "SEMI-DETACHE", "TERRACE HOUS", "TOWN HOUSE", "TRIPLEX", "VILLA HOUSE")

#partial dependence plot: just month number
set.seed(717)
pdp_months = partial(object = gbm_full,
                       train = model,
                       pred.var = "month_num",
                       n.trees = 2000,
                       pred.grid = data.frame(month_num = month_num))


#partial dependence plot: month number and lga
set.seed(717)
pdp_months_lga = partial(object = gbm_full,
                       train = model,
                       pred.var = c("month_num", "LA_DESC"),
                       n.trees = 2000,
                       pred.grid = data.frame(expand.grid(month_num = month_num, LA_DESC = LA_DESC)))


#partial dependence plot: month number and property class
set.seed(717)
pdp_months_class = partial(object = gbm_full,
                       train = model,
                       pred.var = c("month_num", "PROP_CLA"),
                       n.trees = 2000,
                       pred.grid = data.frame(expand.grid(month_num = month_num, PROP_CLA = PROP_CLA)))


#partial dependence plot: month number, property class and LGA (something like this, could develop more, this one is more flexible)
set.seed(717)
pdp_months_lga_class = partial(object = gbm_full,
                       train = model,
                       pred.var = c("month_num", "LA_DESC", "PROP_CLA"),
                       n.trees = 2000,
                       pred.grid = data.frame(expand.grid(month_num = month_num, LA_DESC = LA_DESC, PROP_CLA = PROP_CLA)))

save.image("./full_period_index_monthly.RData")
```


#global accuracy
#simply construct rppi, reference period is financial year 2004
```{r}
#pdp_months
#ls
#gbm_hedonic_index = data.frame(month = 1:204, index = exp(pdp_months$yhat - pdp_months$yhat[1]) * 100)
#write.csv(gbm_hedonic_index, "./data/gbm_hedonic_index.csv")
#lad
gbm_hedonic_index_lad = data.frame(month = 1:204, index = exp(pdp_months$yhat - pdp_months$yhat[1]) * 100)
write.csv(gbm_hedonic_index_lad, "./data/gbm_hedonic_index_lad_monthly.csv")


#alt
#I could use Accumulated local effect rather than pdp, because it is faster and unbiased.
alt = Predictor$new(gbm_full, data = model) # this dataset need to use "model" in line 55, chunk 4.
alt_month = FeatureEffect$new(alt, feature = "month_num", grid.size = 300) # the `grid.size` is quite important, because it controls the outputs. I have 204 months in the data, then I have to change the grid.size to 204 (change it more to 300 for making sure, I can get 204 months), default is 20.
temp = data.frame(alt_month$results)
gbm_hedonic_index_alt = data.frame(month = 1:204, index = 0)
gbm_hedonic_index_alt$index = exp(temp$.value)/exp(temp$.value[1])*100
write.csv(gbm_hedonic_index_alt, "./data/gbm_hedonic_index_alt_monthly.csv")


gbm_hedonic_index_impute = data.frame(month = 1:204, rate = 1, index = 100)
#traditional method
for (i in 1:203){
  temp_pi = model_train_hedonic[which(model_train_hedonic$month_num == i+1),]
  temp_pi$month_num = 1
  prediction_pi = predict(gbm_full, temp_pi, n.trees = 2000)
  pi = exp(mean(temp_pi$logprice - prediction_pi))
  #print(pi)
  
  temp_li = model_train_hedonic[which(model_train_hedonic$month_num == 1),]
  temp_li$month_num = i+1
  prediction_li = predict(gbm_full, temp_li, n.trees = 2000)
  li = exp(mean(prediction_li - temp_li$logprice))
  #print(li)
  
  gbm_hedonic_index_impute$rate[i+1] = sqrt(pi*li)
  gbm_hedonic_index_impute$index[i+1] = gbm_hedonic_index_impute$rate[i+1]*100#prod(gbm_hedonic_index_impute$rate[1:(i+1)])*100
  print(i)
}
gbm_hedonic_index_impute = gbm_hedonic_index_impute[,-2]
write.csv(gbm_hedonic_index_impute, "./data/gbm_hedonic_index_impute_monthly.csv")
```




#indexing rolling windows process
```{r}
#prepare windows for rolling process
for (i in 1:197) {
  temp_train = model[which(model$month_num <= (7+i) & model$month_num >= i),]
  
  assign(paste0("train_window_", i), temp_train)
}


#rolling window 8 months
for(i in 1:197){
  model_window = get(paste0("train_window_",i))
  
  #model in window
  set.seed(717)
  gbm_window = gbm(logprice ~ month_num + LAND_ARE + AREA_HSE + age + BEDS + BATHS + DINING + KITCHEN + FAMILY + STUDY + GAMES + LOUNGE + MEALS + carpark + LA_DESC + PROP_CLA + centlong + centlat + d_pool + d_brick + d_tile + TENCRT, data = model_window, distribution = "gaussian", n.trees = 2000, interaction.depth = 14, shrinkage = 0.05, n.minobsinnode = 15, bag.fraction = 0.5)
  
  #partial dependence plot: just 8 months
  set.seed(717)
  pdp_window = partial(object = gbm_window,
                       train = model_window,
                       pred.var = "month_num",
                       n.trees = 2000,
                       pred.grid = data.frame(month_num = min(model_window$month_num):max(model_window$month_num)))
  
  #save model and pdp
  assign(paste0("gbm_window_",i), gbm_window)
  assign(paste0("pdp_window_",i), pdp_window)
  
  print(paste0("window ",i," is done."))
}

save.image("./rolling_window_index_monthly.RData")
```






#resale indexing
#prepare resales
```{r}
#if use train_test_split_backup, no need to run the next code
#model_train_resale = read.csv("./data/raw_data_2004_2020_RPPI_repeatsales_train.csv")[-1]
resale = data.frame()
for (i in 1:(nrow(model_train_resale)-1)) {
  if(model_train_resale$PARCEL_I[i+1] == model_train_resale$PARCEL_I[i]){
    temp = data.frame(sale = model_train_resale$SALE1[i+1], date = model_train_resale$DATE1[i+1], sale_pre = model_train_resale$SALE1[i], date_pre = model_train_resale$DATE1[i], PROP_CLA = model_train_resale$PROP_CLA[i], LA_DESC = model_train_resale$LA_DESC[i])
    resale = rbind(resale, temp)
    print(i)
  }
}

resale$year = year(resale$date)
resale$year_pre = year(resale$date_pre)
resale$month = month(resale$date)
resale$month_pre = month(resale$date_pre)
resale$month_num = (resale$year - 2004) * 12 + resale$month
resale$month_num_pre = (resale$year_pre - 2004) * 12 + resale$month_pre

model = data.frame(log_diff = log(resale$sale) - log(resale$sale_pre), month = resale$month_num, month_pre = resale$month_num_pre, month_1 = 0, month_2 = 0, month_3 = 0, month_4 = 0, month_5 = 0, month_6 = 0)
model = fastDummies::dummy_cols(model, select_columns = c("month"))
for (i in 1:198) {
  model[which(model$month_pre == i),3+i] = -1
}
model = model[,-c(2,3,4)]
```


#resale index: case-shiller index
```{r}
lm_resale = lm(log_diff ~ . - 1, data = model)
#index
resale_index = data.frame(month = 1:204)
resale_index$index = exp(c(0, lm_resale$coefficients))
resale_index$index = resale_index$index * 100

write.csv(resale_index, "./data/resale_index_monthly.csv")
```




#test the quality of index
#forward
```{r}
resale_test = model_resale %>%
  filter(model_resale$resale_freq > 2)

resale_test$month = month(resale_test$DATE1)
resale_test$month_num = 0
for (i in 2004:2020) {
  resale_test$month_num[which(resale_test$year_sale == i)] = resale_test$month[which(resale_test$year_sale == i)] + (i - 2004) * 12
}

resale_test$resale_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale_lad = 0
resale_test$gbm_hedonic_indexed_sale_alt = 0

#forward predict
for (i in 1:(nrow(resale_test)-1)) {
  if(resale_test$PARCEL_I[i+1] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+1] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+1] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+1])]
      resale_test$gbm_hedonic_indexed_sale[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+1])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+1])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+1])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-2)) {
  if(resale_test$PARCEL_I[i+2] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+2] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+2] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+2])]
      resale_test$gbm_hedonic_indexed_sale[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+2])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+2])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+2])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-3)) {
  if(resale_test$PARCEL_I[i+3] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+3] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+3] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+3])]
      resale_test$gbm_hedonic_indexed_sale[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+3])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+3])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+3])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-4)) {
  if(resale_test$PARCEL_I[i+4] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+4] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+4] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+4])]
      resale_test$gbm_hedonic_indexed_sale[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+4])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+4])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+4])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-5)) {
  if(resale_test$PARCEL_I[i+5] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+5] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+5] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+5])]
      resale_test$gbm_hedonic_indexed_sale[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+5])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+5])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+5])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-6)) {
  if(resale_test$PARCEL_I[i+6] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+6] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+6] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+6])]
      resale_test$gbm_hedonic_indexed_sale[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+6])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+6])]
      resale_test$gbm_hedonic_indexed_sale_alt[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+6])]
    }
  }
  print(i)
}


resale_test = resale_test %>%
  filter(resale_test$train_test == "test")

resale_test = resale_test %>%
  filter(resale_test$resale_indexed_sale > 0 | resale_test$gbm_hedonic_indexed_sale_lad > 0)

RMSE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_alt))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_alt))

MAE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_alt))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_alt)))
```


#backward
```{r}
resale_test = model_resale %>%
  filter(model_resale$resale_freq > 2)

resale_test$month = month(resale_test$DATE1)
resale_test$month_num = 0
for (i in 2004:2020) {
  resale_test$month_num[which(resale_test$year_sale == i)] = resale_test$month[which(resale_test$year_sale == i)] + (i - 2004) * 12
}

resale_test$resale_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale_lad = 0
resale_test$gbm_hedonic_indexed_sale_alt = 0

#backward predict
for (i in 1:(nrow(resale_test)-1)) {
  if(resale_test$PARCEL_I[i+1] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+1] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+1] / resale_index$index[which(resale_index$month == resale_test$month_num[i+1])] * resale_index$index[which(resale_index$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+1] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+1])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+1] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+1])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+1] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+1])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-2)) {
  if(resale_test$PARCEL_I[i+2] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+2] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+2] / resale_index$index[which(resale_index$month == resale_test$month_num[i+2])] * resale_index$index[which(resale_index$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+2] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+2])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+2] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+2])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+2] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+2])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-3)) {
  if(resale_test$PARCEL_I[i+3] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+3] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+3] / resale_index$index[which(resale_index$month == resale_test$month_num[i+3])] * resale_index$index[which(resale_index$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+3] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+3])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+3] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+3])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+3] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+3])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-4)) {
  if(resale_test$PARCEL_I[i+4] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+4] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+4] / resale_index$index[which(resale_index$month == resale_test$month_num[i+4])] * resale_index$index[which(resale_index$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+4] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+4])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+4] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+4])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+4] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+4])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-5)) {
  if(resale_test$PARCEL_I[i+5] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+5] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+5] / resale_index$index[which(resale_index$month == resale_test$month_num[i+5])] * resale_index$index[which(resale_index$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+5] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+5])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+5] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+5])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+5] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+5])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-6)) {
  if(resale_test$PARCEL_I[i+6] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+6] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+6] / resale_index$index[which(resale_index$month == resale_test$month_num[i+6])] * resale_index$index[which(resale_index$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale[i] = resale_test$SALE1[i+6] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+6])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+6] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+6])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i])]
      resale_test$gbm_hedonic_indexed_sale_alt[i] = resale_test$SALE1[i+6] / gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i+6])] * gbm_hedonic_index_alt$index[which(gbm_hedonic_index_alt$month == resale_test$month_num[i])]
    }
  }
  print(i)
}

resale_test = resale_test %>%
  filter(resale_test$train_test == "test")

resale_test = resale_test %>%
  filter(resale_test$resale_indexed_sale > 0 | resale_test$gbm_hedonic_indexed_sale_lad > 0)

RMSE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_alt))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_alt))

MAE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_alt))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_alt)))
```




#index plot
```{r}
indice = rbind(gbm_hedonic_index_impute, gbm_hedonic_index_lad, resale_index)
indice$method = c(rep("Hedonic Impute Index", 204), rep("PDP", 204), rep("Repeat Sale", 204))
ggplot(indice, aes(month, index, color = method)) + geom_line()
```





#local accuracy
#gbm pdp index
```{r}
#pdp_months and LA_DESC
#ls
#gbm_hedonic_index = data.frame(month = pdp_months_lga$month_num, LA_DESC = pdp_months_lga$LA_DESC, index = exp(pdp_months_lga$yhat - baseline) * 100)
#write.csv(gbm_hedonic_index, "./data/gbm_hedonic_index_lga.csv")
#lad
gbm_hedonic_index_lad = pdp_months_lga[order(pdp_months_lga$LA_DESC),]
colnames(gbm_hedonic_index_lad) = c("month", "LA_DESC", "yhat")
gbm_hedonic_index_lad$index = 0
for (i in seq(1,6120,204)) {
  gbm_hedonic_index_lad$index[i:(i+203)] = exp(gbm_hedonic_index_lad$yhat[i:(i+203)]-gbm_hedonic_index_lad$yhat[i])*100
}
gbm_hedonic_index_lad = gbm_hedonic_index_lad[,-3]
write.csv(gbm_hedonic_index_lad, "./data/gbm_hedonic_index_lad_lga_monthly.csv")
```


#gbm pdp index
```{r}
la_desc = data.frame(table(resale$LA_DESC))
gbm_hedonic_index_impute = data.frame(month = rep(1:204,30), rate = 1, LA_DESC = "", index = 100)

n=1
#traditional method
for (i in la_desc[,1]) {
  temp_hedonic = model_train_hedonic[which(model_train_hedonic$LA_DESC == i),]
  for (j in 1:203){
    temp_pi = temp_hedonic[which(temp_hedonic$month_num == j+1),]
    if(nrow(temp_pi) == 0){
      pi = 0
    }
    else{
      temp_pi$month_num = 1
      prediction_pi = predict(gbm_full, temp_pi, n.trees = 2000)
      pi = exp(mean(temp_pi$logprice - prediction_pi))
    }
    #print(pi)
  
    temp_li = temp_hedonic[which(temp_hedonic$month_num == 1),]
    
    if(nrow(temp_li) == 0){
      li = 0
    }
    else{
      temp_li$month_num = j+1
      prediction_li = predict(gbm_full, temp_li, n.trees = 2000)
      li = exp(mean(prediction_li - temp_li$logprice))
    }
    #print(li)
    
    if(pi == 0 | li == 0){
      gbm_hedonic_index_impute$index[(n-1)*204+j+1] = NA
    }
    else{
      gbm_hedonic_index_impute$rate[(n-1)*204+j+1] = sqrt(pi*li)
      gbm_hedonic_index_impute$index[(n-1)*204+j+1] = gbm_hedonic_index_impute$rate[(n-1)*204+j+1]*100#prod(gbm_hedonic_index_impute$rate[((n-1)*204+1):((n-1)*204+j+1)])*100
    }
    print(j)
  }
  gbm_hedonic_index_impute$LA_DESC[((n-1)*204+1):((n-1)*204+204)] = i
  n=n+1
  print(i)
}
gbm_hedonic_index_impute = gbm_hedonic_index_impute[,-2]
write.csv(gbm_hedonic_index_impute, "./data/gbm_hedonic_index_impute_lga_monthly.csv")
```


#resale index
```{r}
la_desc = data.frame(table(resale$LA_DESC))
resale_index = data.frame()
for (i in la_desc[,1]) {
  temp_resale = resale[which(resale$LA_DESC == i),]
  model = data.frame(log_diff = log(temp_resale$sale) - log(temp_resale$sale_pre), month = temp_resale$month_num, month_pre = temp_resale$month_num_pre, month_1 = 0, month_2 = 0, month_3 = 0, month_4 = 0, month_5 = 0, month_6 = 0, month_7 = 0, month_8 = 0, month_9 = 0, month_10 = 0, month_11 = 0, month_12 = 0, month_13 = 0, month_14 = 0, month_15 = 0, month_16 = 0, month_17 = 0, month_18 = 0, month_19 = 0, month_20 = 0, month_21 = 0, month_22 = 0, month_23 = 0, month_24 = 0, month_25 = 0, month_26 = 0, month_27 = 0, month_28 = 0, month_29 = 0, month_30 = 0, month_31 = 0, month_32 = 0, month_33 = 0, month_34 = 0, month_35 = 0, month_36 = 0, month_37 = 0, month_38 = 0, month_39 = 0, month_40 = 0, month_41 = 0, month_42 = 0, month_43 = 0, month_44 = 0, month_45 = 0, month_46 = 0, month_47 = 0, month_48 = 0, month_49 = 0, month_50 = 0, month_51 = 0, month_52 = 0, month_53 = 0, month_54 = 0, month_55 = 0, month_56 = 0, month_57 = 0, month_58 = 0, month_59 = 0, month_60 = 0, month_61 = 0, month_62 = 0, month_63 = 0, month_64 = 0, month_65 = 0, month_66 = 0, month_67 = 0, month_68 = 0, month_69 = 0, month_70 = 0, month_71 = 0, month_72 = 0, month_73 = 0, month_74 = 0, month_75 = 0, month_76 = 0, month_77 = 0, month_78 = 0, month_79 = 0, month_80 = 0, month_81 = 0, month_82 = 0, month_83 = 0, month_84 = 0, month_85 = 0, month_86 = 0, month_87 = 0, month_88 = 0, month_89 = 0, month_90 = 0, month_91 = 0, month_92 = 0, month_93 = 0, month_94 = 0, month_95 = 0, month_96 = 0, month_97 = 0, month_98 = 0, month_99 = 0, month_100 = 0, month_101 = 0, month_102 = 0, month_103 = 0, month_104 = 0, month_105 = 0, month_106 = 0, month_107 = 0, month_108 = 0, month_109 = 0, month_110 = 0, month_111 = 0, month_112 = 0, month_113 = 0, month_114 = 0, month_115 = 0, month_116 = 0, month_117 = 0, month_118 = 0, month_119 = 0, month_120 = 0, month_121 = 0, month_122 = 0, month_123 = 0, month_124 = 0, month_125 = 0, month_126 = 0, month_127 = 0, month_128 = 0, month_129 = 0, month_130 = 0, month_131 = 0, month_132 = 0, month_133 = 0, month_134 = 0, month_135 = 0, month_136 = 0, month_137 = 0, month_138 = 0, month_139 = 0, month_140 = 0, month_141 = 0, month_142 = 0, month_143 = 0, month_144 = 0, month_145 = 0, month_146 = 0, month_147 = 0, month_148 = 0, month_149 = 0, month_150 = 0, month_151 = 0, month_152 = 0, month_153 = 0, month_154 = 0, month_155 = 0, month_156 = 0, month_157 = 0, month_158 = 0, month_159 = 0, month_160 = 0, month_161 = 0, month_162 = 0, month_163 = 0, month_164 = 0, month_165 = 0, month_166 = 0, month_167 = 0, month_168 = 0, month_169 = 0, month_170 = 0, month_171 = 0, month_172 = 0, month_173 = 0, month_174 = 0, month_175 = 0, month_176 = 0, month_177 = 0, month_178 = 0, month_179 = 0, month_180 = 0, month_181 = 0, month_182 = 0, month_183 = 0, month_184 = 0, month_185 = 0, month_186 = 0, month_187 = 0, month_188 = 0, month_189 = 0, month_190 = 0, month_191 = 0, month_192 = 0, month_193 = 0, month_194 = 0, month_195 = 0, month_196 = 0, month_197 = 0, month_198 = 0, month_199 = 0, month_200 = 0, month_201 = 0, month_202 = 0, month_203 = 0, month_204 = 0)
  for (j in 1:204) {
    model[which(model$month == j),3+j] = 1
  }
  for (j in 1:204) {
    model[which(model$month_pre == j),3+j] = -1
  }
  model = model[,-c(2,3,4)]

  lm_resale_temp = lm(log_diff ~ . - 1, data = model)
  #index
  resale_index_temp = data.frame(month = 1:204)
  resale_index_temp$LA_DESC = i
  resale_index_temp$index = exp(c(0, lm_resale_temp$coefficients))
  resale_index_temp$index = resale_index_temp$index * 100
  
  
  resale_index = rbind(resale_index, resale_index_temp)
  print(i)
}
```




#test the quality of index
```{r}
resale_test = model_resale %>%
  filter(model_resale$resale_freq > 2)

resale_test$month = month(resale_test$DATE1)
resale_test$month_num = 0
for (i in 2004:2020) {
  resale_test$month_num[which(resale_test$year_sale == i)] = resale_test$month[which(resale_test$year_sale == i)] + (i - 2004) * 12
}

resale_test$resale_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale_lad = 0

#forward predict
for (i in 1:(nrow(resale_test)-1)) {
  if(resale_test$PARCEL_I[i+1] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+1] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+1] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+1] & resale_index$LA_DESC == resale_test$LA_DESC[i+1])]
      resale_test$gbm_hedonic_indexed_sale[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+1] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+1])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+1] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+1])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-2)) {
  if(resale_test$PARCEL_I[i+2] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+2] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+2] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+2] & resale_index$LA_DESC == resale_test$LA_DESC[i+2])]
      resale_test$gbm_hedonic_indexed_sale[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+2] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+2])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+2] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+2])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-3)) {
  if(resale_test$PARCEL_I[i+3] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+3] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+3] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+3] & resale_index$LA_DESC == resale_test$LA_DESC[i+3])]
      resale_test$gbm_hedonic_indexed_sale[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+3] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+3])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+3] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+3])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-4)) {
  if(resale_test$PARCEL_I[i+4] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+4] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+4] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+4] & resale_index$LA_DESC == resale_test$LA_DESC[i+4])]
      resale_test$gbm_hedonic_indexed_sale[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+4] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+4])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+4] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+4])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-5)) {
  if(resale_test$PARCEL_I[i+5] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+5] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+5] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+5] & resale_index$LA_DESC == resale_test$LA_DESC[i+5])]
      resale_test$gbm_hedonic_indexed_sale[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+5] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+5])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+5] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+5])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-6)) {
  if(resale_test$PARCEL_I[i+6] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+6] == "test" & resale_test$train_test[i] == "train"){
      resale_test$resale_indexed_sale[i+6] = resale_test$SALE1[i] / resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])] * resale_index$index[which(resale_index$month == resale_test$month_num[i+6] & resale_index$LA_DESC == resale_test$LA_DESC[i+6])]
      resale_test$gbm_hedonic_indexed_sale[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+6] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+6])]
      resale_test$gbm_hedonic_indexed_sale_lad[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+6] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+6])]
    }
  }
  print(i)
}


resale_test = resale_test %>%
  filter(resale_test$train_test == "test")

resale_test = resale_test %>%
  filter(resale_test$resale_indexed_sale > 0 & resale_test$gbm_hedonic_indexed_sale_lad > 0 & resale_test$gbm_hedonic_indexed_sale > 0)#resale index could have some NA value, which can not predict. could use & to get the results 

RMSE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad))

MAE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad)))
```


#backward
```{r}
resale_test = model_resale %>%
  filter(model_resale$resale_freq > 2)

resale_test$month = month(resale_test$DATE1)
resale_test$month_num = 0
for (i in 2004:2020) {
  resale_test$month_num[which(resale_test$year_sale == i)] = resale_test$month[which(resale_test$year_sale == i)] + (i - 2004) * 12
}

resale_test$resale_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale = 0
resale_test$gbm_hedonic_indexed_sale_lad = 0

#backward predict
for (i in 1:(nrow(resale_test)-1)) {
  if(resale_test$PARCEL_I[i+1] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+1] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+1] / resale_index$index[which(resale_index$month == resale_test$month_num[i+1] & resale_index$LA_DESC == resale_test$LA_DESC[i+1])] * resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])]
      resale_test$gbm_hedonic_indexed_sale[i+1] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+1] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+1])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+1] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+1] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+1])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-2)) {
  if(resale_test$PARCEL_I[i+2] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+2] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+2] / resale_index$index[which(resale_index$month == resale_test$month_num[i+2] & resale_index$LA_DESC == resale_test$LA_DESC[i+2])] * resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])]
      resale_test$gbm_hedonic_indexed_sale[i+2] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+2] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+2])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+2] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+2] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+2])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-3)) {
  if(resale_test$PARCEL_I[i+3] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+3] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+3] / resale_index$index[which(resale_index$month == resale_test$month_num[i+3] & resale_index$LA_DESC == resale_test$LA_DESC[i+3])] * resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])]
      resale_test$gbm_hedonic_indexed_sale[i+3] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+3] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+3])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+3] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+3] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+3])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-4)) {
  if(resale_test$PARCEL_I[i+4] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+4] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+4] / resale_index$index[which(resale_index$month == resale_test$month_num[i+4] & resale_index$LA_DESC == resale_test$LA_DESC[i+4])] * resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])]
      resale_test$gbm_hedonic_indexed_sale[i+4] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+4] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+4])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+4] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+4] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+4])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-5)) {
  if(resale_test$PARCEL_I[i+5] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+5] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+5] / resale_index$index[which(resale_index$month == resale_test$month_num[i+5] & resale_index$LA_DESC == resale_test$LA_DESC[i+5])] * resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])]
      resale_test$gbm_hedonic_indexed_sale[i+5] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+5] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+5])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+5] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+5] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+5])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])]
    }
  }
  print(i)
}
for (i in 1:(nrow(resale_test)-6)) {
  if(resale_test$PARCEL_I[i+6] == resale_test$PARCEL_I[i]){
    if(resale_test$train_test[i+6] == "train" & resale_test$train_test[i] == "test"){
      resale_test$resale_indexed_sale[i] = resale_test$SALE1[i+6] / resale_index$index[which(resale_index$month == resale_test$month_num[i+6] & resale_index$LA_DESC == resale_test$LA_DESC[i+6])] * resale_index$index[which(resale_index$month == resale_test$month_num[i] & resale_index$LA_DESC == resale_test$LA_DESC[i])]
      resale_test$gbm_hedonic_indexed_sale[i+6] = resale_test$SALE1[i] / gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i])] * gbm_hedonic_index_impute$index[which(gbm_hedonic_index_impute$month == resale_test$month_num[i+6] & gbm_hedonic_index_impute$LA_DESC == resale_test$LA_DESC[i+6])]
      resale_test$gbm_hedonic_indexed_sale_lad[i] = resale_test$SALE1[i+6] / gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i+6] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i+6])] * gbm_hedonic_index_lad$index[which(gbm_hedonic_index_lad$month == resale_test$month_num[i] & gbm_hedonic_index_lad$LA_DESC == resale_test$LA_DESC[i])]
    }
  }
  print(i)
}

resale_test = resale_test %>%
  filter(resale_test$train_test == "test")

resale_test = resale_test %>%
  filter(resale_test$resale_indexed_sale > 0 | resale_test$gbm_hedonic_indexed_sale_lad > 0)#resale index could have some NA value, which can not predict. could use & to get the results 

RMSE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale))
RMSE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad))

MAE(log(resale_test$SALE1), log(resale_test$resale_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$resale_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale)))
MAE(log(resale_test$SALE1), log(resale_test$gbm_hedonic_indexed_sale_lad))
median(abs(log(resale_test$SALE1) - log(resale_test$gbm_hedonic_indexed_sale_lad)))
```